(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const An="modulepreload",Ln=function(e,i){return new URL(e,i).href},Ht={},ge=function(i,t,n){if(!t||t.length===0)return i();const a=document.getElementsByTagName("link");return Promise.all(t.map(r=>{if(r=Ln(r,n),r in Ht)return;Ht[r]=!0;const s=r.endsWith(".css"),o=s?'[rel="stylesheet"]':"";if(!!n)for(let c=a.length-1;c>=0;c--){const _=a[c];if(_.href===r&&(!s||_.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${o}`))return;const l=document.createElement("link");if(l.rel=s?"stylesheet":An,s||(l.as="script",l.crossOrigin=""),l.href=r,document.head.appendChild(l),s)return new Promise((c,_)=>{l.addEventListener("load",c),l.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${r}`)))})})).then(()=>i()).catch(r=>{const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r})};class P extends Error{}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Tn=4,Zt=0,Wt=1,Rn=2;function Se(e){let i=e.length;for(;--i>=0;)e[i]=0}const Cn=0,Ui=1,Fn=2,Mn=3,Bn=258,Mt=29,Ze=256,Be=Ze+1+Mt,be=30,Bt=19,Hi=2*Be+1,se=15,lt=16,Dn=7,Dt=256,Zi=16,Wi=17,Gi=18,vt=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Qe=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),On=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Ki=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zn=512,X=new Array((Be+2)*2);Se(X);const Re=new Array(be*2);Se(Re);const De=new Array(zn);Se(De);const Oe=new Array(Bn-Mn+1);Se(Oe);const Ot=new Array(Mt);Se(Ot);const et=new Array(be);Se(et);function ct(e,i,t,n,a){this.static_tree=e,this.extra_bits=i,this.extra_base=t,this.elems=n,this.max_length=a,this.has_stree=e&&e.length}let ji,Ji,Vi;function dt(e,i){this.dyn_tree=e,this.max_code=0,this.stat_desc=i}const Xi=e=>e<256?De[e]:De[256+(e>>>7)],ze=(e,i)=>{e.pending_buf[e.pending++]=i&255,e.pending_buf[e.pending++]=i>>>8&255},O=(e,i,t)=>{e.bi_valid>lt-t?(e.bi_buf|=i<<e.bi_valid&65535,ze(e,e.bi_buf),e.bi_buf=i>>lt-e.bi_valid,e.bi_valid+=t-lt):(e.bi_buf|=i<<e.bi_valid&65535,e.bi_valid+=t)},G=(e,i,t)=>{O(e,t[i*2],t[i*2+1])},Yi=(e,i)=>{let t=0;do t|=e&1,e>>>=1,t<<=1;while(--i>0);return t>>>1},Pn=e=>{e.bi_valid===16?(ze(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},$n=(e,i)=>{const t=i.dyn_tree,n=i.max_code,a=i.stat_desc.static_tree,r=i.stat_desc.has_stree,s=i.stat_desc.extra_bits,o=i.stat_desc.extra_base,d=i.stat_desc.max_length;let l,c,_,f,h,g,v=0;for(f=0;f<=se;f++)e.bl_count[f]=0;for(t[e.heap[e.heap_max]*2+1]=0,l=e.heap_max+1;l<Hi;l++)c=e.heap[l],f=t[t[c*2+1]*2+1]+1,f>d&&(f=d,v++),t[c*2+1]=f,!(c>n)&&(e.bl_count[f]++,h=0,c>=o&&(h=s[c-o]),g=t[c*2],e.opt_len+=g*(f+h),r&&(e.static_len+=g*(a[c*2+1]+h)));if(v!==0){do{for(f=d-1;e.bl_count[f]===0;)f--;e.bl_count[f]--,e.bl_count[f+1]+=2,e.bl_count[d]--,v-=2}while(v>0);for(f=d;f!==0;f--)for(c=e.bl_count[f];c!==0;)_=e.heap[--l],!(_>n)&&(t[_*2+1]!==f&&(e.opt_len+=(f-t[_*2+1])*t[_*2],t[_*2+1]=f),c--)}},qi=(e,i,t)=>{const n=new Array(se+1);let a=0,r,s;for(r=1;r<=se;r++)a=a+t[r-1]<<1,n[r]=a;for(s=0;s<=i;s++){let o=e[s*2+1];o!==0&&(e[s*2]=Yi(n[o]++,o))}},Nn=()=>{let e,i,t,n,a;const r=new Array(se+1);for(t=0,n=0;n<Mt-1;n++)for(Ot[n]=t,e=0;e<1<<vt[n];e++)Oe[t++]=n;for(Oe[t-1]=n,a=0,n=0;n<16;n++)for(et[n]=a,e=0;e<1<<Qe[n];e++)De[a++]=n;for(a>>=7;n<be;n++)for(et[n]=a<<7,e=0;e<1<<Qe[n]-7;e++)De[256+a++]=n;for(i=0;i<=se;i++)r[i]=0;for(e=0;e<=143;)X[e*2+1]=8,e++,r[8]++;for(;e<=255;)X[e*2+1]=9,e++,r[9]++;for(;e<=279;)X[e*2+1]=7,e++,r[7]++;for(;e<=287;)X[e*2+1]=8,e++,r[8]++;for(qi(X,Be+1,r),e=0;e<be;e++)Re[e*2+1]=5,Re[e*2]=Yi(e,5);ji=new ct(X,vt,Ze+1,Be,se),Ji=new ct(Re,Qe,0,be,se),Vi=new ct(new Array(0),On,0,Bt,Dn)},Qi=e=>{let i;for(i=0;i<Be;i++)e.dyn_ltree[i*2]=0;for(i=0;i<be;i++)e.dyn_dtree[i*2]=0;for(i=0;i<Bt;i++)e.bl_tree[i*2]=0;e.dyn_ltree[Dt*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},en=e=>{e.bi_valid>8?ze(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},Gt=(e,i,t,n)=>{const a=i*2,r=t*2;return e[a]<e[r]||e[a]===e[r]&&n[i]<=n[t]},ht=(e,i,t)=>{const n=e.heap[t];let a=t<<1;for(;a<=e.heap_len&&(a<e.heap_len&&Gt(i,e.heap[a+1],e.heap[a],e.depth)&&a++,!Gt(i,n,e.heap[a],e.depth));)e.heap[t]=e.heap[a],t=a,a<<=1;e.heap[t]=n},Kt=(e,i,t)=>{let n,a,r=0,s,o;if(e.sym_next!==0)do n=e.pending_buf[e.sym_buf+r++]&255,n+=(e.pending_buf[e.sym_buf+r++]&255)<<8,a=e.pending_buf[e.sym_buf+r++],n===0?G(e,a,i):(s=Oe[a],G(e,s+Ze+1,i),o=vt[s],o!==0&&(a-=Ot[s],O(e,a,o)),n--,s=Xi(n),G(e,s,t),o=Qe[s],o!==0&&(n-=et[s],O(e,n,o)));while(r<e.sym_next);G(e,Dt,i)},xt=(e,i)=>{const t=i.dyn_tree,n=i.stat_desc.static_tree,a=i.stat_desc.has_stree,r=i.stat_desc.elems;let s,o,d=-1,l;for(e.heap_len=0,e.heap_max=Hi,s=0;s<r;s++)t[s*2]!==0?(e.heap[++e.heap_len]=d=s,e.depth[s]=0):t[s*2+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=d<2?++d:0,t[l*2]=1,e.depth[l]=0,e.opt_len--,a&&(e.static_len-=n[l*2+1]);for(i.max_code=d,s=e.heap_len>>1;s>=1;s--)ht(e,t,s);l=r;do s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],ht(e,t,1),o=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=o,t[l*2]=t[s*2]+t[o*2],e.depth[l]=(e.depth[s]>=e.depth[o]?e.depth[s]:e.depth[o])+1,t[s*2+1]=t[o*2+1]=l,e.heap[1]=l++,ht(e,t,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],$n(e,i),qi(t,d,e.bl_count)},jt=(e,i,t)=>{let n,a=-1,r,s=i[0*2+1],o=0,d=7,l=4;for(s===0&&(d=138,l=3),i[(t+1)*2+1]=65535,n=0;n<=t;n++)r=s,s=i[(n+1)*2+1],!(++o<d&&r===s)&&(o<l?e.bl_tree[r*2]+=o:r!==0?(r!==a&&e.bl_tree[r*2]++,e.bl_tree[Zi*2]++):o<=10?e.bl_tree[Wi*2]++:e.bl_tree[Gi*2]++,o=0,a=r,s===0?(d=138,l=3):r===s?(d=6,l=3):(d=7,l=4))},Jt=(e,i,t)=>{let n,a=-1,r,s=i[0*2+1],o=0,d=7,l=4;for(s===0&&(d=138,l=3),n=0;n<=t;n++)if(r=s,s=i[(n+1)*2+1],!(++o<d&&r===s)){if(o<l)do G(e,r,e.bl_tree);while(--o!==0);else r!==0?(r!==a&&(G(e,r,e.bl_tree),o--),G(e,Zi,e.bl_tree),O(e,o-3,2)):o<=10?(G(e,Wi,e.bl_tree),O(e,o-3,3)):(G(e,Gi,e.bl_tree),O(e,o-11,7));o=0,a=r,s===0?(d=138,l=3):r===s?(d=6,l=3):(d=7,l=4)}},Un=e=>{let i;for(jt(e,e.dyn_ltree,e.l_desc.max_code),jt(e,e.dyn_dtree,e.d_desc.max_code),xt(e,e.bl_desc),i=Bt-1;i>=3&&e.bl_tree[Ki[i]*2+1]===0;i--);return e.opt_len+=3*(i+1)+5+5+4,i},Hn=(e,i,t,n)=>{let a;for(O(e,i-257,5),O(e,t-1,5),O(e,n-4,4),a=0;a<n;a++)O(e,e.bl_tree[Ki[a]*2+1],3);Jt(e,e.dyn_ltree,i-1),Jt(e,e.dyn_dtree,t-1)},Zn=e=>{let i=4093624447,t;for(t=0;t<=31;t++,i>>>=1)if(i&1&&e.dyn_ltree[t*2]!==0)return Zt;if(e.dyn_ltree[9*2]!==0||e.dyn_ltree[10*2]!==0||e.dyn_ltree[13*2]!==0)return Wt;for(t=32;t<Ze;t++)if(e.dyn_ltree[t*2]!==0)return Wt;return Zt};let Vt=!1;const Wn=e=>{Vt||(Nn(),Vt=!0),e.l_desc=new dt(e.dyn_ltree,ji),e.d_desc=new dt(e.dyn_dtree,Ji),e.bl_desc=new dt(e.bl_tree,Vi),e.bi_buf=0,e.bi_valid=0,Qi(e)},tn=(e,i,t,n)=>{O(e,(Cn<<1)+(n?1:0),3),en(e),ze(e,t),ze(e,~t),t&&e.pending_buf.set(e.window.subarray(i,i+t),e.pending),e.pending+=t},Gn=e=>{O(e,Ui<<1,3),G(e,Dt,X),Pn(e)},Kn=(e,i,t,n)=>{let a,r,s=0;e.level>0?(e.strm.data_type===Rn&&(e.strm.data_type=Zn(e)),xt(e,e.l_desc),xt(e,e.d_desc),s=Un(e),a=e.opt_len+3+7>>>3,r=e.static_len+3+7>>>3,r<=a&&(a=r)):a=r=t+5,t+4<=a&&i!==-1?tn(e,i,t,n):e.strategy===Tn||r===a?(O(e,(Ui<<1)+(n?1:0),3),Kt(e,X,Re)):(O(e,(Fn<<1)+(n?1:0),3),Hn(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),Kt(e,e.dyn_ltree,e.dyn_dtree)),Qi(e),n&&en(e)},jn=(e,i,t)=>(e.pending_buf[e.sym_buf+e.sym_next++]=i,e.pending_buf[e.sym_buf+e.sym_next++]=i>>8,e.pending_buf[e.sym_buf+e.sym_next++]=t,i===0?e.dyn_ltree[t*2]++:(e.matches++,i--,e.dyn_ltree[(Oe[t]+Ze+1)*2]++,e.dyn_dtree[Xi(i)*2]++),e.sym_next===e.sym_end);var Jn=Wn,Vn=tn,Xn=Kn,Yn=jn,qn=Gn,Qn={_tr_init:Jn,_tr_stored_block:Vn,_tr_flush_block:Xn,_tr_tally:Yn,_tr_align:qn};const ea=(e,i,t,n)=>{let a=e&65535|0,r=e>>>16&65535|0,s=0;for(;t!==0;){s=t>2e3?2e3:t,t-=s;do a=a+i[n++]|0,r=r+a|0;while(--s);a%=65521,r%=65521}return a|r<<16|0};var Pe=ea;const ta=()=>{let e,i=[];for(var t=0;t<256;t++){e=t;for(var n=0;n<8;n++)e=e&1?3988292384^e>>>1:e>>>1;i[t]=e}return i},ia=new Uint32Array(ta()),na=(e,i,t,n)=>{const a=ia,r=n+t;e^=-1;for(let s=n;s<r;s++)e=e>>>8^a[(e^i[s])&255];return e^-1};var F=na,de={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ve={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:aa,_tr_stored_block:It,_tr_flush_block:ra,_tr_tally:te,_tr_align:sa}=Qn,{Z_NO_FLUSH:ie,Z_PARTIAL_FLUSH:oa,Z_FULL_FLUSH:la,Z_FINISH:U,Z_BLOCK:Xt,Z_OK:M,Z_STREAM_END:Yt,Z_STREAM_ERROR:K,Z_DATA_ERROR:ca,Z_BUF_ERROR:ft,Z_DEFAULT_COMPRESSION:da,Z_FILTERED:ha,Z_HUFFMAN_ONLY:Je,Z_RLE:fa,Z_FIXED:_a,Z_DEFAULT_STRATEGY:ua,Z_UNKNOWN:ga,Z_DEFLATED:nt}=ve,wa=9,pa=15,ma=8,ba=29,ya=256,kt=ya+1+ba,Ea=30,Sa=19,va=2*kt+1,xa=15,A=3,ee=258,j=ee+A+1,Ia=32,ye=42,zt=57,At=69,Lt=73,Tt=91,Rt=103,oe=113,Ae=666,B=1,xe=2,he=3,Ie=4,ka=3,le=(e,i)=>(e.msg=de[i],i),qt=e=>e*2-(e>4?9:0),q=e=>{let i=e.length;for(;--i>=0;)e[i]=0},Aa=e=>{let i,t,n,a=e.w_size;i=e.hash_size,n=i;do t=e.head[--n],e.head[n]=t>=a?t-a:0;while(--i);i=a,n=i;do t=e.prev[--n],e.prev[n]=t>=a?t-a:0;while(--i)};let La=(e,i,t)=>(i<<e.hash_shift^t)&e.hash_mask,ne=La;const $=e=>{const i=e.state;let t=i.pending;t>e.avail_out&&(t=e.avail_out),t!==0&&(e.output.set(i.pending_buf.subarray(i.pending_out,i.pending_out+t),e.next_out),e.next_out+=t,i.pending_out+=t,e.total_out+=t,e.avail_out-=t,i.pending-=t,i.pending===0&&(i.pending_out=0))},N=(e,i)=>{ra(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,i),e.block_start=e.strstart,$(e.strm)},L=(e,i)=>{e.pending_buf[e.pending++]=i},ke=(e,i)=>{e.pending_buf[e.pending++]=i>>>8&255,e.pending_buf[e.pending++]=i&255},Ct=(e,i,t,n)=>{let a=e.avail_in;return a>n&&(a=n),a===0?0:(e.avail_in-=a,i.set(e.input.subarray(e.next_in,e.next_in+a),t),e.state.wrap===1?e.adler=Pe(e.adler,i,a,t):e.state.wrap===2&&(e.adler=F(e.adler,i,a,t)),e.next_in+=a,e.total_in+=a,a)},nn=(e,i)=>{let t=e.max_chain_length,n=e.strstart,a,r,s=e.prev_length,o=e.nice_match;const d=e.strstart>e.w_size-j?e.strstart-(e.w_size-j):0,l=e.window,c=e.w_mask,_=e.prev,f=e.strstart+ee;let h=l[n+s-1],g=l[n+s];e.prev_length>=e.good_match&&(t>>=2),o>e.lookahead&&(o=e.lookahead);do if(a=i,!(l[a+s]!==g||l[a+s-1]!==h||l[a]!==l[n]||l[++a]!==l[n+1])){n+=2,a++;do;while(l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&l[++n]===l[++a]&&n<f);if(r=ee-(f-n),n=f-ee,r>s){if(e.match_start=i,s=r,r>=o)break;h=l[n+s-1],g=l[n+s]}}while((i=_[i&c])>d&&--t!==0);return s<=e.lookahead?s:e.lookahead},Ee=e=>{const i=e.w_size;let t,n,a;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=i+(i-j)&&(e.window.set(e.window.subarray(i,i+i-n),0),e.match_start-=i,e.strstart-=i,e.block_start-=i,e.insert>e.strstart&&(e.insert=e.strstart),Aa(e),n+=i),e.strm.avail_in===0)break;if(t=Ct(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=t,e.lookahead+e.insert>=A)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=ne(e,e.ins_h,e.window[a+1]);e.insert&&(e.ins_h=ne(e,e.ins_h,e.window[a+A-1]),e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<A)););}while(e.lookahead<j&&e.strm.avail_in!==0)},an=(e,i)=>{let t=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,n,a,r,s=0,o=e.strm.avail_in;do{if(n=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r||(r=e.strm.avail_out-r,a=e.strstart-e.block_start,n>a+e.strm.avail_in&&(n=a+e.strm.avail_in),n>r&&(n=r),n<t&&(n===0&&i!==U||i===ie||n!==a+e.strm.avail_in)))break;s=i===U&&n===a+e.strm.avail_in?1:0,It(e,0,0,s),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,$(e.strm),a&&(a>n&&(a=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+a),e.strm.next_out),e.strm.next_out+=a,e.strm.avail_out-=a,e.strm.total_out+=a,e.block_start+=a,n-=a),n&&(Ct(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(s===0);return o-=e.strm.avail_in,o&&(o>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=o&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-o,e.strm.next_in),e.strstart),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?Ie:i!==ie&&i!==U&&e.strm.avail_in===0&&e.strstart===e.block_start?xe:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(Ct(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,t=r>e.w_size?e.w_size:r,a=e.strstart-e.block_start,(a>=t||(a||i===U)&&i!==ie&&e.strm.avail_in===0&&a<=r)&&(n=a>r?r:a,s=i===U&&e.strm.avail_in===0&&n===a?1:0,It(e,e.block_start,n,s),e.block_start+=n,$(e.strm)),s?he:B)},_t=(e,i)=>{let t,n;for(;;){if(e.lookahead<j){if(Ee(e),e.lookahead<j&&i===ie)return B;if(e.lookahead===0)break}if(t=0,e.lookahead>=A&&(e.ins_h=ne(e,e.ins_h,e.window[e.strstart+A-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),t!==0&&e.strstart-t<=e.w_size-j&&(e.match_length=nn(e,t)),e.match_length>=A)if(n=te(e,e.strstart-e.match_start,e.match_length-A),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=A){e.match_length--;do e.strstart++,e.ins_h=ne(e,e.ins_h,e.window[e.strstart+A-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=ne(e,e.ins_h,e.window[e.strstart+1]);else n=te(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(N(e,!1),e.strm.avail_out===0))return B}return e.insert=e.strstart<A-1?e.strstart:A-1,i===U?(N(e,!0),e.strm.avail_out===0?he:Ie):e.sym_next&&(N(e,!1),e.strm.avail_out===0)?B:xe},we=(e,i)=>{let t,n,a;for(;;){if(e.lookahead<j){if(Ee(e),e.lookahead<j&&i===ie)return B;if(e.lookahead===0)break}if(t=0,e.lookahead>=A&&(e.ins_h=ne(e,e.ins_h,e.window[e.strstart+A-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=A-1,t!==0&&e.prev_length<e.max_lazy_match&&e.strstart-t<=e.w_size-j&&(e.match_length=nn(e,t),e.match_length<=5&&(e.strategy===ha||e.match_length===A&&e.strstart-e.match_start>4096)&&(e.match_length=A-1)),e.prev_length>=A&&e.match_length<=e.prev_length){a=e.strstart+e.lookahead-A,n=te(e,e.strstart-1-e.prev_match,e.prev_length-A),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=a&&(e.ins_h=ne(e,e.ins_h,e.window[e.strstart+A-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=A-1,e.strstart++,n&&(N(e,!1),e.strm.avail_out===0))return B}else if(e.match_available){if(n=te(e,0,e.window[e.strstart-1]),n&&N(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return B}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=te(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<A-1?e.strstart:A-1,i===U?(N(e,!0),e.strm.avail_out===0?he:Ie):e.sym_next&&(N(e,!1),e.strm.avail_out===0)?B:xe},Ta=(e,i)=>{let t,n,a,r;const s=e.window;for(;;){if(e.lookahead<=ee){if(Ee(e),e.lookahead<=ee&&i===ie)return B;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=A&&e.strstart>0&&(a=e.strstart-1,n=s[a],n===s[++a]&&n===s[++a]&&n===s[++a])){r=e.strstart+ee;do;while(n===s[++a]&&n===s[++a]&&n===s[++a]&&n===s[++a]&&n===s[++a]&&n===s[++a]&&n===s[++a]&&n===s[++a]&&a<r);e.match_length=ee-(r-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=A?(t=te(e,1,e.match_length-A),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(t=te(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),t&&(N(e,!1),e.strm.avail_out===0))return B}return e.insert=0,i===U?(N(e,!0),e.strm.avail_out===0?he:Ie):e.sym_next&&(N(e,!1),e.strm.avail_out===0)?B:xe},Ra=(e,i)=>{let t;for(;;){if(e.lookahead===0&&(Ee(e),e.lookahead===0)){if(i===ie)return B;break}if(e.match_length=0,t=te(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,t&&(N(e,!1),e.strm.avail_out===0))return B}return e.insert=0,i===U?(N(e,!0),e.strm.avail_out===0?he:Ie):e.sym_next&&(N(e,!1),e.strm.avail_out===0)?B:xe};function Z(e,i,t,n,a){this.good_length=e,this.max_lazy=i,this.nice_length=t,this.max_chain=n,this.func=a}const Le=[new Z(0,0,0,0,an),new Z(4,4,8,4,_t),new Z(4,5,16,8,_t),new Z(4,6,32,32,_t),new Z(4,4,16,16,we),new Z(8,16,32,32,we),new Z(8,16,128,128,we),new Z(8,32,128,256,we),new Z(32,128,258,1024,we),new Z(32,258,258,4096,we)],Ca=e=>{e.window_size=2*e.w_size,q(e.head),e.max_lazy_match=Le[e.level].max_lazy,e.good_match=Le[e.level].good_length,e.nice_match=Le[e.level].nice_length,e.max_chain_length=Le[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=A-1,e.match_available=0,e.ins_h=0};function Fa(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=nt,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(va*2),this.dyn_dtree=new Uint16Array((2*Ea+1)*2),this.bl_tree=new Uint16Array((2*Sa+1)*2),q(this.dyn_ltree),q(this.dyn_dtree),q(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(xa+1),this.heap=new Uint16Array(2*kt+1),q(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*kt+1),q(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const We=e=>{if(!e)return 1;const i=e.state;return!i||i.strm!==e||i.status!==ye&&i.status!==zt&&i.status!==At&&i.status!==Lt&&i.status!==Tt&&i.status!==Rt&&i.status!==oe&&i.status!==Ae?1:0},rn=e=>{if(We(e))return le(e,K);e.total_in=e.total_out=0,e.data_type=ga;const i=e.state;return i.pending=0,i.pending_out=0,i.wrap<0&&(i.wrap=-i.wrap),i.status=i.wrap===2?zt:i.wrap?ye:oe,e.adler=i.wrap===2?0:1,i.last_flush=-2,aa(i),M},sn=e=>{const i=rn(e);return i===M&&Ca(e.state),i},Ma=(e,i)=>We(e)||e.state.wrap!==2?K:(e.state.gzhead=i,M),on=(e,i,t,n,a,r)=>{if(!e)return K;let s=1;if(i===da&&(i=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),a<1||a>wa||t!==nt||n<8||n>15||i<0||i>9||r<0||r>_a||n===8&&s!==1)return le(e,K);n===8&&(n=9);const o=new Fa;return e.state=o,o.strm=e,o.status=ye,o.wrap=s,o.gzhead=null,o.w_bits=n,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=a+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+A-1)/A),o.window=new Uint8Array(o.w_size*2),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<a+6,o.pending_buf_size=o.lit_bufsize*4,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=(o.lit_bufsize-1)*3,o.level=i,o.strategy=r,o.method=t,sn(e)},Ba=(e,i)=>on(e,i,nt,pa,ma,ua),Da=(e,i)=>{if(We(e)||i>Xt||i<0)return e?le(e,K):K;const t=e.state;if(!e.output||e.avail_in!==0&&!e.input||t.status===Ae&&i!==U)return le(e,e.avail_out===0?ft:K);const n=t.last_flush;if(t.last_flush=i,t.pending!==0){if($(e),e.avail_out===0)return t.last_flush=-1,M}else if(e.avail_in===0&&qt(i)<=qt(n)&&i!==U)return le(e,ft);if(t.status===Ae&&e.avail_in!==0)return le(e,ft);if(t.status===ye&&t.wrap===0&&(t.status=oe),t.status===ye){let a=nt+(t.w_bits-8<<4)<<8,r=-1;if(t.strategy>=Je||t.level<2?r=0:t.level<6?r=1:t.level===6?r=2:r=3,a|=r<<6,t.strstart!==0&&(a|=Ia),a+=31-a%31,ke(t,a),t.strstart!==0&&(ke(t,e.adler>>>16),ke(t,e.adler&65535)),e.adler=1,t.status=oe,$(e),t.pending!==0)return t.last_flush=-1,M}if(t.status===zt){if(e.adler=0,L(t,31),L(t,139),L(t,8),t.gzhead)L(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),L(t,t.gzhead.time&255),L(t,t.gzhead.time>>8&255),L(t,t.gzhead.time>>16&255),L(t,t.gzhead.time>>24&255),L(t,t.level===9?2:t.strategy>=Je||t.level<2?4:0),L(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(L(t,t.gzhead.extra.length&255),L(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(e.adler=F(e.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=At;else if(L(t,0),L(t,0),L(t,0),L(t,0),L(t,0),L(t,t.level===9?2:t.strategy>=Je||t.level<2?4:0),L(t,ka),t.status=oe,$(e),t.pending!==0)return t.last_flush=-1,M}if(t.status===At){if(t.gzhead.extra){let a=t.pending,r=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+r>t.pending_buf_size;){let o=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+o),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex+=o,$(e),t.pending!==0)return t.last_flush=-1,M;a=0,r-=o}let s=new Uint8Array(t.gzhead.extra);t.pending_buf.set(s.subarray(t.gzindex,t.gzindex+r),t.pending),t.pending+=r,t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex=0}t.status=Lt}if(t.status===Lt){if(t.gzhead.name){let a=t.pending,r;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a)),$(e),t.pending!==0)return t.last_flush=-1,M;a=0}t.gzindex<t.gzhead.name.length?r=t.gzhead.name.charCodeAt(t.gzindex++)&255:r=0,L(t,r)}while(r!==0);t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex=0}t.status=Tt}if(t.status===Tt){if(t.gzhead.comment){let a=t.pending,r;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a)),$(e),t.pending!==0)return t.last_flush=-1,M;a=0}t.gzindex<t.gzhead.comment.length?r=t.gzhead.comment.charCodeAt(t.gzindex++)&255:r=0,L(t,r)}while(r!==0);t.gzhead.hcrc&&t.pending>a&&(e.adler=F(e.adler,t.pending_buf,t.pending-a,a))}t.status=Rt}if(t.status===Rt){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&($(e),t.pending!==0))return t.last_flush=-1,M;L(t,e.adler&255),L(t,e.adler>>8&255),e.adler=0}if(t.status=oe,$(e),t.pending!==0)return t.last_flush=-1,M}if(e.avail_in!==0||t.lookahead!==0||i!==ie&&t.status!==Ae){let a=t.level===0?an(t,i):t.strategy===Je?Ra(t,i):t.strategy===fa?Ta(t,i):Le[t.level].func(t,i);if((a===he||a===Ie)&&(t.status=Ae),a===B||a===he)return e.avail_out===0&&(t.last_flush=-1),M;if(a===xe&&(i===oa?sa(t):i!==Xt&&(It(t,0,0,!1),i===la&&(q(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),$(e),e.avail_out===0))return t.last_flush=-1,M}return i!==U?M:t.wrap<=0?Yt:(t.wrap===2?(L(t,e.adler&255),L(t,e.adler>>8&255),L(t,e.adler>>16&255),L(t,e.adler>>24&255),L(t,e.total_in&255),L(t,e.total_in>>8&255),L(t,e.total_in>>16&255),L(t,e.total_in>>24&255)):(ke(t,e.adler>>>16),ke(t,e.adler&65535)),$(e),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?M:Yt)},Oa=e=>{if(We(e))return K;const i=e.state.status;return e.state=null,i===oe?le(e,ca):M},za=(e,i)=>{let t=i.length;if(We(e))return K;const n=e.state,a=n.wrap;if(a===2||a===1&&n.status!==ye||n.lookahead)return K;if(a===1&&(e.adler=Pe(e.adler,i,t,0)),n.wrap=0,t>=n.w_size){a===0&&(q(n.head),n.strstart=0,n.block_start=0,n.insert=0);let d=new Uint8Array(n.w_size);d.set(i.subarray(t-n.w_size,t),0),i=d,t=n.w_size}const r=e.avail_in,s=e.next_in,o=e.input;for(e.avail_in=t,e.next_in=0,e.input=i,Ee(n);n.lookahead>=A;){let d=n.strstart,l=n.lookahead-(A-1);do n.ins_h=ne(n,n.ins_h,n.window[d+A-1]),n.prev[d&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=d,d++;while(--l);n.strstart=d,n.lookahead=A-1,Ee(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=A-1,n.match_available=0,e.next_in=s,e.input=o,e.avail_in=r,n.wrap=a,M};var Pa=Ba,$a=on,Na=sn,Ua=rn,Ha=Ma,Za=Da,Wa=Oa,Ga=za,Ka="pako deflate (from Nodeca project)",Ce={deflateInit:Pa,deflateInit2:$a,deflateReset:Na,deflateResetKeep:Ua,deflateSetHeader:Ha,deflate:Za,deflateEnd:Wa,deflateSetDictionary:Ga,deflateInfo:Ka};const ja=(e,i)=>Object.prototype.hasOwnProperty.call(e,i);var Ja=function(e){const i=Array.prototype.slice.call(arguments,1);for(;i.length;){const t=i.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const n in t)ja(t,n)&&(e[n]=t[n])}}return e},Va=e=>{let i=0;for(let n=0,a=e.length;n<a;n++)i+=e[n].length;const t=new Uint8Array(i);for(let n=0,a=0,r=e.length;n<r;n++){let s=e[n];t.set(s,a),a+=s.length}return t},at={assign:Ja,flattenChunks:Va};let ln=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{ln=!1}const $e=new Uint8Array(256);for(let e=0;e<256;e++)$e[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;$e[254]=$e[254]=1;var Xa=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let i,t,n,a,r,s=e.length,o=0;for(a=0;a<s;a++)t=e.charCodeAt(a),(t&64512)===55296&&a+1<s&&(n=e.charCodeAt(a+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),a++)),o+=t<128?1:t<2048?2:t<65536?3:4;for(i=new Uint8Array(o),r=0,a=0;r<o;a++)t=e.charCodeAt(a),(t&64512)===55296&&a+1<s&&(n=e.charCodeAt(a+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),a++)),t<128?i[r++]=t:t<2048?(i[r++]=192|t>>>6,i[r++]=128|t&63):t<65536?(i[r++]=224|t>>>12,i[r++]=128|t>>>6&63,i[r++]=128|t&63):(i[r++]=240|t>>>18,i[r++]=128|t>>>12&63,i[r++]=128|t>>>6&63,i[r++]=128|t&63);return i};const Ya=(e,i)=>{if(i<65534&&e.subarray&&ln)return String.fromCharCode.apply(null,e.length===i?e:e.subarray(0,i));let t="";for(let n=0;n<i;n++)t+=String.fromCharCode(e[n]);return t};var qa=(e,i)=>{const t=i||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,i));let n,a;const r=new Array(t*2);for(a=0,n=0;n<t;){let s=e[n++];if(s<128){r[a++]=s;continue}let o=$e[s];if(o>4){r[a++]=65533,n+=o-1;continue}for(s&=o===2?31:o===3?15:7;o>1&&n<t;)s=s<<6|e[n++]&63,o--;if(o>1){r[a++]=65533;continue}s<65536?r[a++]=s:(s-=65536,r[a++]=55296|s>>10&1023,r[a++]=56320|s&1023)}return Ya(r,a)},Qa=(e,i)=>{i=i||e.length,i>e.length&&(i=e.length);let t=i-1;for(;t>=0&&(e[t]&192)===128;)t--;return t<0||t===0?i:t+$e[e[t]]>i?t:i},Ne={string2buf:Xa,buf2string:qa,utf8border:Qa};function er(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var cn=er;const dn=Object.prototype.toString,{Z_NO_FLUSH:tr,Z_SYNC_FLUSH:ir,Z_FULL_FLUSH:nr,Z_FINISH:ar,Z_OK:tt,Z_STREAM_END:rr,Z_DEFAULT_COMPRESSION:sr,Z_DEFAULT_STRATEGY:or,Z_DEFLATED:lr}=ve;function Ge(e){this.options=at.assign({level:sr,method:lr,chunkSize:16384,windowBits:15,memLevel:8,strategy:or},e||{});let i=this.options;i.raw&&i.windowBits>0?i.windowBits=-i.windowBits:i.gzip&&i.windowBits>0&&i.windowBits<16&&(i.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new cn,this.strm.avail_out=0;let t=Ce.deflateInit2(this.strm,i.level,i.method,i.windowBits,i.memLevel,i.strategy);if(t!==tt)throw new Error(de[t]);if(i.header&&Ce.deflateSetHeader(this.strm,i.header),i.dictionary){let n;if(typeof i.dictionary=="string"?n=Ne.string2buf(i.dictionary):dn.call(i.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(i.dictionary):n=i.dictionary,t=Ce.deflateSetDictionary(this.strm,n),t!==tt)throw new Error(de[t]);this._dict_set=!0}}Ge.prototype.push=function(e,i){const t=this.strm,n=this.options.chunkSize;let a,r;if(this.ended)return!1;for(i===~~i?r=i:r=i===!0?ar:tr,typeof e=="string"?t.input=Ne.string2buf(e):dn.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),(r===ir||r===nr)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(a=Ce.deflate(t,r),a===rr)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),a=Ce.deflateEnd(this.strm),this.onEnd(a),this.ended=!0,a===tt;if(t.avail_out===0){this.onData(t.output);continue}if(r>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};Ge.prototype.onData=function(e){this.chunks.push(e)};Ge.prototype.onEnd=function(e){e===tt&&(this.result=at.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function Pt(e,i){const t=new Ge(i);if(t.push(e,!0),t.err)throw t.msg||de[t.err];return t.result}function cr(e,i){return i=i||{},i.raw=!0,Pt(e,i)}function dr(e,i){return i=i||{},i.gzip=!0,Pt(e,i)}var hr=Ge,fr=Pt,_r=cr,ur=dr,gr=ve,wr={Deflate:hr,deflate:fr,deflateRaw:_r,gzip:ur,constants:gr};const Ve=16209,pr=16191;var mr=function(i,t){let n,a,r,s,o,d,l,c,_,f,h,g,v,p,m,x,E,u,S,C,w,k,b,y;const I=i.state;n=i.next_in,b=i.input,a=n+(i.avail_in-5),r=i.next_out,y=i.output,s=r-(t-i.avail_out),o=r+(i.avail_out-257),d=I.dmax,l=I.wsize,c=I.whave,_=I.wnext,f=I.window,h=I.hold,g=I.bits,v=I.lencode,p=I.distcode,m=(1<<I.lenbits)-1,x=(1<<I.distbits)-1;e:do{g<15&&(h+=b[n++]<<g,g+=8,h+=b[n++]<<g,g+=8),E=v[h&m];t:for(;;){if(u=E>>>24,h>>>=u,g-=u,u=E>>>16&255,u===0)y[r++]=E&65535;else if(u&16){S=E&65535,u&=15,u&&(g<u&&(h+=b[n++]<<g,g+=8),S+=h&(1<<u)-1,h>>>=u,g-=u),g<15&&(h+=b[n++]<<g,g+=8,h+=b[n++]<<g,g+=8),E=p[h&x];i:for(;;){if(u=E>>>24,h>>>=u,g-=u,u=E>>>16&255,u&16){if(C=E&65535,u&=15,g<u&&(h+=b[n++]<<g,g+=8,g<u&&(h+=b[n++]<<g,g+=8)),C+=h&(1<<u)-1,C>d){i.msg="invalid distance too far back",I.mode=Ve;break e}if(h>>>=u,g-=u,u=r-s,C>u){if(u=C-u,u>c&&I.sane){i.msg="invalid distance too far back",I.mode=Ve;break e}if(w=0,k=f,_===0){if(w+=l-u,u<S){S-=u;do y[r++]=f[w++];while(--u);w=r-C,k=y}}else if(_<u){if(w+=l+_-u,u-=_,u<S){S-=u;do y[r++]=f[w++];while(--u);if(w=0,_<S){u=_,S-=u;do y[r++]=f[w++];while(--u);w=r-C,k=y}}}else if(w+=_-u,u<S){S-=u;do y[r++]=f[w++];while(--u);w=r-C,k=y}for(;S>2;)y[r++]=k[w++],y[r++]=k[w++],y[r++]=k[w++],S-=3;S&&(y[r++]=k[w++],S>1&&(y[r++]=k[w++]))}else{w=r-C;do y[r++]=y[w++],y[r++]=y[w++],y[r++]=y[w++],S-=3;while(S>2);S&&(y[r++]=y[w++],S>1&&(y[r++]=y[w++]))}}else if(u&64){i.msg="invalid distance code",I.mode=Ve;break e}else{E=p[(E&65535)+(h&(1<<u)-1)];continue i}break}}else if(u&64)if(u&32){I.mode=pr;break e}else{i.msg="invalid literal/length code",I.mode=Ve;break e}else{E=v[(E&65535)+(h&(1<<u)-1)];continue t}break}}while(n<a&&r<o);S=g>>3,n-=S,g-=S<<3,h&=(1<<g)-1,i.next_in=n,i.next_out=r,i.avail_in=n<a?5+(a-n):5-(n-a),i.avail_out=r<o?257+(o-r):257-(r-o),I.hold=h,I.bits=g};const pe=15,Qt=852,ei=592,ti=0,ut=1,ii=2,br=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),yr=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Er=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Sr=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),vr=(e,i,t,n,a,r,s,o)=>{const d=o.bits;let l=0,c=0,_=0,f=0,h=0,g=0,v=0,p=0,m=0,x=0,E,u,S,C,w,k=null,b;const y=new Uint16Array(pe+1),I=new Uint16Array(pe+1);let z=null,ot,ue,je;for(l=0;l<=pe;l++)y[l]=0;for(c=0;c<n;c++)y[i[t+c]]++;for(h=d,f=pe;f>=1&&y[f]===0;f--);if(h>f&&(h=f),f===0)return a[r++]=1<<24|64<<16|0,a[r++]=1<<24|64<<16|0,o.bits=1,0;for(_=1;_<f&&y[_]===0;_++);for(h<_&&(h=_),p=1,l=1;l<=pe;l++)if(p<<=1,p-=y[l],p<0)return-1;if(p>0&&(e===ti||f!==1))return-1;for(I[1]=0,l=1;l<pe;l++)I[l+1]=I[l]+y[l];for(c=0;c<n;c++)i[t+c]!==0&&(s[I[i[t+c]]++]=c);if(e===ti?(k=z=s,b=20):e===ut?(k=br,z=yr,b=257):(k=Er,z=Sr,b=0),x=0,c=0,l=_,w=r,g=h,v=0,S=-1,m=1<<h,C=m-1,e===ut&&m>Qt||e===ii&&m>ei)return 1;for(;;){ot=l-v,s[c]+1<b?(ue=0,je=s[c]):s[c]>=b?(ue=z[s[c]-b],je=k[s[c]-b]):(ue=32+64,je=0),E=1<<l-v,u=1<<g,_=u;do u-=E,a[w+(x>>v)+u]=ot<<24|ue<<16|je|0;while(u!==0);for(E=1<<l-1;x&E;)E>>=1;if(E!==0?(x&=E-1,x+=E):x=0,c++,--y[l]===0){if(l===f)break;l=i[t+s[c]]}if(l>h&&(x&C)!==S){for(v===0&&(v=h),w+=_,g=l-v,p=1<<g;g+v<f&&(p-=y[g+v],!(p<=0));)g++,p<<=1;if(m+=1<<g,e===ut&&m>Qt||e===ii&&m>ei)return 1;S=x&C,a[S]=h<<24|g<<16|w-r|0}}return x!==0&&(a[w+x]=l-v<<24|64<<16|0),o.bits=h,0};var Fe=vr;const xr=0,hn=1,fn=2,{Z_FINISH:ni,Z_BLOCK:Ir,Z_TREES:Xe,Z_OK:fe,Z_STREAM_END:kr,Z_NEED_DICT:Ar,Z_STREAM_ERROR:H,Z_DATA_ERROR:_n,Z_MEM_ERROR:un,Z_BUF_ERROR:Lr,Z_DEFLATED:ai}=ve,rt=16180,ri=16181,si=16182,oi=16183,li=16184,ci=16185,di=16186,hi=16187,fi=16188,_i=16189,it=16190,V=16191,gt=16192,ui=16193,wt=16194,gi=16195,wi=16196,pi=16197,mi=16198,Ye=16199,qe=16200,bi=16201,yi=16202,Ei=16203,Si=16204,vi=16205,pt=16206,xi=16207,Ii=16208,R=16209,gn=16210,wn=16211,Tr=852,Rr=592,Cr=15,Fr=Cr,ki=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function Mr(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const _e=e=>{if(!e)return 1;const i=e.state;return!i||i.strm!==e||i.mode<rt||i.mode>wn?1:0},pn=e=>{if(_e(e))return H;const i=e.state;return e.total_in=e.total_out=i.total=0,e.msg="",i.wrap&&(e.adler=i.wrap&1),i.mode=rt,i.last=0,i.havedict=0,i.flags=-1,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new Int32Array(Tr),i.distcode=i.distdyn=new Int32Array(Rr),i.sane=1,i.back=-1,fe},mn=e=>{if(_e(e))return H;const i=e.state;return i.wsize=0,i.whave=0,i.wnext=0,pn(e)},bn=(e,i)=>{let t;if(_e(e))return H;const n=e.state;return i<0?(t=0,i=-i):(t=(i>>4)+5,i<48&&(i&=15)),i&&(i<8||i>15)?H:(n.window!==null&&n.wbits!==i&&(n.window=null),n.wrap=t,n.wbits=i,mn(e))},yn=(e,i)=>{if(!e)return H;const t=new Mr;e.state=t,t.strm=e,t.window=null,t.mode=rt;const n=bn(e,i);return n!==fe&&(e.state=null),n},Br=e=>yn(e,Fr);let Ai=!0,mt,bt;const Dr=e=>{if(Ai){mt=new Int32Array(512),bt=new Int32Array(32);let i=0;for(;i<144;)e.lens[i++]=8;for(;i<256;)e.lens[i++]=9;for(;i<280;)e.lens[i++]=7;for(;i<288;)e.lens[i++]=8;for(Fe(hn,e.lens,0,288,mt,0,e.work,{bits:9}),i=0;i<32;)e.lens[i++]=5;Fe(fn,e.lens,0,32,bt,0,e.work,{bits:5}),Ai=!1}e.lencode=mt,e.lenbits=9,e.distcode=bt,e.distbits=5},En=(e,i,t,n)=>{let a;const r=e.state;return r.window===null&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new Uint8Array(r.wsize)),n>=r.wsize?(r.window.set(i.subarray(t-r.wsize,t),0),r.wnext=0,r.whave=r.wsize):(a=r.wsize-r.wnext,a>n&&(a=n),r.window.set(i.subarray(t-n,t-n+a),r.wnext),n-=a,n?(r.window.set(i.subarray(t-n,t),0),r.wnext=n,r.whave=r.wsize):(r.wnext+=a,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=a))),0},Or=(e,i)=>{let t,n,a,r,s,o,d,l,c,_,f,h,g,v,p=0,m,x,E,u,S,C,w,k;const b=new Uint8Array(4);let y,I;const z=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(_e(e)||!e.output||!e.input&&e.avail_in!==0)return H;t=e.state,t.mode===V&&(t.mode=gt),s=e.next_out,a=e.output,d=e.avail_out,r=e.next_in,n=e.input,o=e.avail_in,l=t.hold,c=t.bits,_=o,f=d,k=fe;e:for(;;)switch(t.mode){case rt:if(t.wrap===0){t.mode=gt;break}for(;c<16;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(t.wrap&2&&l===35615){t.wbits===0&&(t.wbits=15),t.check=0,b[0]=l&255,b[1]=l>>>8&255,t.check=F(t.check,b,2,0),l=0,c=0,t.mode=ri;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((l&255)<<8)+(l>>8))%31){e.msg="incorrect header check",t.mode=R;break}if((l&15)!==ai){e.msg="unknown compression method",t.mode=R;break}if(l>>>=4,c-=4,w=(l&15)+8,t.wbits===0&&(t.wbits=w),w>15||w>t.wbits){e.msg="invalid window size",t.mode=R;break}t.dmax=1<<t.wbits,t.flags=0,e.adler=t.check=1,t.mode=l&512?_i:V,l=0,c=0;break;case ri:for(;c<16;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(t.flags=l,(t.flags&255)!==ai){e.msg="unknown compression method",t.mode=R;break}if(t.flags&57344){e.msg="unknown header flags set",t.mode=R;break}t.head&&(t.head.text=l>>8&1),t.flags&512&&t.wrap&4&&(b[0]=l&255,b[1]=l>>>8&255,t.check=F(t.check,b,2,0)),l=0,c=0,t.mode=si;case si:for(;c<32;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.head&&(t.head.time=l),t.flags&512&&t.wrap&4&&(b[0]=l&255,b[1]=l>>>8&255,b[2]=l>>>16&255,b[3]=l>>>24&255,t.check=F(t.check,b,4,0)),l=0,c=0,t.mode=oi;case oi:for(;c<16;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.head&&(t.head.xflags=l&255,t.head.os=l>>8),t.flags&512&&t.wrap&4&&(b[0]=l&255,b[1]=l>>>8&255,t.check=F(t.check,b,2,0)),l=0,c=0,t.mode=li;case li:if(t.flags&1024){for(;c<16;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.length=l,t.head&&(t.head.extra_len=l),t.flags&512&&t.wrap&4&&(b[0]=l&255,b[1]=l>>>8&255,t.check=F(t.check,b,2,0)),l=0,c=0}else t.head&&(t.head.extra=null);t.mode=ci;case ci:if(t.flags&1024&&(h=t.length,h>o&&(h=o),h&&(t.head&&(w=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(n.subarray(r,r+h),w)),t.flags&512&&t.wrap&4&&(t.check=F(t.check,n,h,r)),o-=h,r+=h,t.length-=h),t.length))break e;t.length=0,t.mode=di;case di:if(t.flags&2048){if(o===0)break e;h=0;do w=n[r+h++],t.head&&w&&t.length<65536&&(t.head.name+=String.fromCharCode(w));while(w&&h<o);if(t.flags&512&&t.wrap&4&&(t.check=F(t.check,n,h,r)),o-=h,r+=h,w)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=hi;case hi:if(t.flags&4096){if(o===0)break e;h=0;do w=n[r+h++],t.head&&w&&t.length<65536&&(t.head.comment+=String.fromCharCode(w));while(w&&h<o);if(t.flags&512&&t.wrap&4&&(t.check=F(t.check,n,h,r)),o-=h,r+=h,w)break e}else t.head&&(t.head.comment=null);t.mode=fi;case fi:if(t.flags&512){for(;c<16;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(t.wrap&4&&l!==(t.check&65535)){e.msg="header crc mismatch",t.mode=R;break}l=0,c=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=V;break;case _i:for(;c<32;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}e.adler=t.check=ki(l),l=0,c=0,t.mode=it;case it:if(t.havedict===0)return e.next_out=s,e.avail_out=d,e.next_in=r,e.avail_in=o,t.hold=l,t.bits=c,Ar;e.adler=t.check=1,t.mode=V;case V:if(i===Ir||i===Xe)break e;case gt:if(t.last){l>>>=c&7,c-=c&7,t.mode=pt;break}for(;c<3;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}switch(t.last=l&1,l>>>=1,c-=1,l&3){case 0:t.mode=ui;break;case 1:if(Dr(t),t.mode=Ye,i===Xe){l>>>=2,c-=2;break e}break;case 2:t.mode=wi;break;case 3:e.msg="invalid block type",t.mode=R}l>>>=2,c-=2;break;case ui:for(l>>>=c&7,c-=c&7;c<32;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if((l&65535)!==(l>>>16^65535)){e.msg="invalid stored block lengths",t.mode=R;break}if(t.length=l&65535,l=0,c=0,t.mode=wt,i===Xe)break e;case wt:t.mode=gi;case gi:if(h=t.length,h){if(h>o&&(h=o),h>d&&(h=d),h===0)break e;a.set(n.subarray(r,r+h),s),o-=h,r+=h,d-=h,s+=h,t.length-=h;break}t.mode=V;break;case wi:for(;c<14;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(t.nlen=(l&31)+257,l>>>=5,c-=5,t.ndist=(l&31)+1,l>>>=5,c-=5,t.ncode=(l&15)+4,l>>>=4,c-=4,t.nlen>286||t.ndist>30){e.msg="too many length or distance symbols",t.mode=R;break}t.have=0,t.mode=pi;case pi:for(;t.have<t.ncode;){for(;c<3;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.lens[z[t.have++]]=l&7,l>>>=3,c-=3}for(;t.have<19;)t.lens[z[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,y={bits:t.lenbits},k=Fe(xr,t.lens,0,19,t.lencode,0,t.work,y),t.lenbits=y.bits,k){e.msg="invalid code lengths set",t.mode=R;break}t.have=0,t.mode=mi;case mi:for(;t.have<t.nlen+t.ndist;){for(;p=t.lencode[l&(1<<t.lenbits)-1],m=p>>>24,x=p>>>16&255,E=p&65535,!(m<=c);){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(E<16)l>>>=m,c-=m,t.lens[t.have++]=E;else{if(E===16){for(I=m+2;c<I;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(l>>>=m,c-=m,t.have===0){e.msg="invalid bit length repeat",t.mode=R;break}w=t.lens[t.have-1],h=3+(l&3),l>>>=2,c-=2}else if(E===17){for(I=m+3;c<I;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}l>>>=m,c-=m,w=0,h=3+(l&7),l>>>=3,c-=3}else{for(I=m+7;c<I;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}l>>>=m,c-=m,w=0,h=11+(l&127),l>>>=7,c-=7}if(t.have+h>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=R;break}for(;h--;)t.lens[t.have++]=w}}if(t.mode===R)break;if(t.lens[256]===0){e.msg="invalid code -- missing end-of-block",t.mode=R;break}if(t.lenbits=9,y={bits:t.lenbits},k=Fe(hn,t.lens,0,t.nlen,t.lencode,0,t.work,y),t.lenbits=y.bits,k){e.msg="invalid literal/lengths set",t.mode=R;break}if(t.distbits=6,t.distcode=t.distdyn,y={bits:t.distbits},k=Fe(fn,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,y),t.distbits=y.bits,k){e.msg="invalid distances set",t.mode=R;break}if(t.mode=Ye,i===Xe)break e;case Ye:t.mode=qe;case qe:if(o>=6&&d>=258){e.next_out=s,e.avail_out=d,e.next_in=r,e.avail_in=o,t.hold=l,t.bits=c,mr(e,f),s=e.next_out,a=e.output,d=e.avail_out,r=e.next_in,n=e.input,o=e.avail_in,l=t.hold,c=t.bits,t.mode===V&&(t.back=-1);break}for(t.back=0;p=t.lencode[l&(1<<t.lenbits)-1],m=p>>>24,x=p>>>16&255,E=p&65535,!(m<=c);){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(x&&!(x&240)){for(u=m,S=x,C=E;p=t.lencode[C+((l&(1<<u+S)-1)>>u)],m=p>>>24,x=p>>>16&255,E=p&65535,!(u+m<=c);){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}l>>>=u,c-=u,t.back+=u}if(l>>>=m,c-=m,t.back+=m,t.length=E,x===0){t.mode=vi;break}if(x&32){t.back=-1,t.mode=V;break}if(x&64){e.msg="invalid literal/length code",t.mode=R;break}t.extra=x&15,t.mode=bi;case bi:if(t.extra){for(I=t.extra;c<I;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.length+=l&(1<<t.extra)-1,l>>>=t.extra,c-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=yi;case yi:for(;p=t.distcode[l&(1<<t.distbits)-1],m=p>>>24,x=p>>>16&255,E=p&65535,!(m<=c);){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(!(x&240)){for(u=m,S=x,C=E;p=t.distcode[C+((l&(1<<u+S)-1)>>u)],m=p>>>24,x=p>>>16&255,E=p&65535,!(u+m<=c);){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}l>>>=u,c-=u,t.back+=u}if(l>>>=m,c-=m,t.back+=m,x&64){e.msg="invalid distance code",t.mode=R;break}t.offset=E,t.extra=x&15,t.mode=Ei;case Ei:if(t.extra){for(I=t.extra;c<I;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}t.offset+=l&(1<<t.extra)-1,l>>>=t.extra,c-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=R;break}t.mode=Si;case Si:if(d===0)break e;if(h=f-d,t.offset>h){if(h=t.offset-h,h>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=R;break}h>t.wnext?(h-=t.wnext,g=t.wsize-h):g=t.wnext-h,h>t.length&&(h=t.length),v=t.window}else v=a,g=s-t.offset,h=t.length;h>d&&(h=d),d-=h,t.length-=h;do a[s++]=v[g++];while(--h);t.length===0&&(t.mode=qe);break;case vi:if(d===0)break e;a[s++]=t.length,d--,t.mode=qe;break;case pt:if(t.wrap){for(;c<32;){if(o===0)break e;o--,l|=n[r++]<<c,c+=8}if(f-=d,e.total_out+=f,t.total+=f,t.wrap&4&&f&&(e.adler=t.check=t.flags?F(t.check,a,f,s-f):Pe(t.check,a,f,s-f)),f=d,t.wrap&4&&(t.flags?l:ki(l))!==t.check){e.msg="incorrect data check",t.mode=R;break}l=0,c=0}t.mode=xi;case xi:if(t.wrap&&t.flags){for(;c<32;){if(o===0)break e;o--,l+=n[r++]<<c,c+=8}if(t.wrap&4&&l!==(t.total&4294967295)){e.msg="incorrect length check",t.mode=R;break}l=0,c=0}t.mode=Ii;case Ii:k=kr;break e;case R:k=_n;break e;case gn:return un;case wn:default:return H}return e.next_out=s,e.avail_out=d,e.next_in=r,e.avail_in=o,t.hold=l,t.bits=c,(t.wsize||f!==e.avail_out&&t.mode<R&&(t.mode<pt||i!==ni))&&En(e,e.output,e.next_out,f-e.avail_out),_-=e.avail_in,f-=e.avail_out,e.total_in+=_,e.total_out+=f,t.total+=f,t.wrap&4&&f&&(e.adler=t.check=t.flags?F(t.check,a,f,e.next_out-f):Pe(t.check,a,f,e.next_out-f)),e.data_type=t.bits+(t.last?64:0)+(t.mode===V?128:0)+(t.mode===Ye||t.mode===wt?256:0),(_===0&&f===0||i===ni)&&k===fe&&(k=Lr),k},zr=e=>{if(_e(e))return H;let i=e.state;return i.window&&(i.window=null),e.state=null,fe},Pr=(e,i)=>{if(_e(e))return H;const t=e.state;return t.wrap&2?(t.head=i,i.done=!1,fe):H},$r=(e,i)=>{const t=i.length;let n,a,r;return _e(e)||(n=e.state,n.wrap!==0&&n.mode!==it)?H:n.mode===it&&(a=1,a=Pe(a,i,t,0),a!==n.check)?_n:(r=En(e,i,t,t),r?(n.mode=gn,un):(n.havedict=1,fe))};var Nr=mn,Ur=bn,Hr=pn,Zr=Br,Wr=yn,Gr=Or,Kr=zr,jr=Pr,Jr=$r,Vr="pako inflate (from Nodeca project)",Y={inflateReset:Nr,inflateReset2:Ur,inflateResetKeep:Hr,inflateInit:Zr,inflateInit2:Wr,inflate:Gr,inflateEnd:Kr,inflateGetHeader:jr,inflateSetDictionary:Jr,inflateInfo:Vr};function Xr(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Yr=Xr;const Sn=Object.prototype.toString,{Z_NO_FLUSH:qr,Z_FINISH:Qr,Z_OK:Ue,Z_STREAM_END:yt,Z_NEED_DICT:Et,Z_STREAM_ERROR:es,Z_DATA_ERROR:Li,Z_MEM_ERROR:ts}=ve;function Ke(e){this.options=at.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const i=this.options;i.raw&&i.windowBits>=0&&i.windowBits<16&&(i.windowBits=-i.windowBits,i.windowBits===0&&(i.windowBits=-15)),i.windowBits>=0&&i.windowBits<16&&!(e&&e.windowBits)&&(i.windowBits+=32),i.windowBits>15&&i.windowBits<48&&(i.windowBits&15||(i.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new cn,this.strm.avail_out=0;let t=Y.inflateInit2(this.strm,i.windowBits);if(t!==Ue)throw new Error(de[t]);if(this.header=new Yr,Y.inflateGetHeader(this.strm,this.header),i.dictionary&&(typeof i.dictionary=="string"?i.dictionary=Ne.string2buf(i.dictionary):Sn.call(i.dictionary)==="[object ArrayBuffer]"&&(i.dictionary=new Uint8Array(i.dictionary)),i.raw&&(t=Y.inflateSetDictionary(this.strm,i.dictionary),t!==Ue)))throw new Error(de[t])}Ke.prototype.push=function(e,i){const t=this.strm,n=this.options.chunkSize,a=this.options.dictionary;let r,s,o;if(this.ended)return!1;for(i===~~i?s=i:s=i===!0?Qr:qr,Sn.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),r=Y.inflate(t,s),r===Et&&a&&(r=Y.inflateSetDictionary(t,a),r===Ue?r=Y.inflate(t,s):r===Li&&(r=Et));t.avail_in>0&&r===yt&&t.state.wrap>0&&e[t.next_in]!==0;)Y.inflateReset(t),r=Y.inflate(t,s);switch(r){case es:case Li:case Et:case ts:return this.onEnd(r),this.ended=!0,!1}if(o=t.avail_out,t.next_out&&(t.avail_out===0||r===yt))if(this.options.to==="string"){let d=Ne.utf8border(t.output,t.next_out),l=t.next_out-d,c=Ne.buf2string(t.output,d);t.next_out=l,t.avail_out=n-l,l&&t.output.set(t.output.subarray(d,d+l),0),this.onData(c)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(r===Ue&&o===0)){if(r===yt)return r=Y.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};Ke.prototype.onData=function(e){this.chunks.push(e)};Ke.prototype.onEnd=function(e){e===Ue&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=at.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function $t(e,i){const t=new Ke(i);if(t.push(e),t.err)throw t.msg||de[t.err];return t.result}function is(e,i){return i=i||{},i.raw=!0,$t(e,i)}var ns=Ke,as=$t,rs=is,ss=$t,os=ve,ls={Inflate:ns,inflate:as,inflateRaw:rs,ungzip:ss,constants:os};const{Deflate:ks,deflate:cs,deflateRaw:As,gzip:Ls}=wr,{Inflate:ds,inflate:Ts,inflateRaw:Rs,ungzip:Cs}=ls;var hs=cs,fs=ds;async function _s(e){switch(e){case 15736195:{const{ESP32ROM:i}=await ge(()=>import("./esp32-ea6ce03f.js"),["./esp32-ea6ce03f.js","./rom-74524d0c.js"],import.meta.url);return new i}case 1763790959:case 456216687:{const{ESP32C3ROM:i}=await ge(()=>import("./esp32c3-b5062337.js"),["./esp32c3-b5062337.js","./rom-74524d0c.js"],import.meta.url);return new i}case 752910447:{const{ESP32C6ROM:i}=await ge(()=>import("./esp32c6-a0e48e87.js"),["./esp32c6-a0e48e87.js","./rom-74524d0c.js"],import.meta.url);return new i}case 9:{const{ESP32S3ROM:i}=await ge(()=>import("./esp32s3-0049c7aa.js"),["./esp32s3-0049c7aa.js","./rom-74524d0c.js"],import.meta.url);return new i}case 1990:{const{ESP32S2ROM:i}=await ge(()=>import("./esp32s2-a8038710.js"),["./esp32s2-a8038710.js","./rom-74524d0c.js"],import.meta.url);return new i}case 4293968129:{const{ESP8266ROM:i}=await ge(()=>import("./esp8266-5b2b537a.js"),["./esp8266-5b2b537a.js","./rom-74524d0c.js"],import.meta.url);return new i}default:return null}}class us{constructor(i,t,n,a=115200,r=!1){this.transport=i,this.baudrate=t,this.terminal=n,this.rom_baudrate=a,this.debugLogging=r,this.ESP_RAM_BLOCK=6144,this.ESP_FLASH_BEGIN=2,this.ESP_FLASH_DATA=3,this.ESP_FLASH_END=4,this.ESP_MEM_BEGIN=5,this.ESP_MEM_END=6,this.ESP_MEM_DATA=7,this.ESP_WRITE_REG=9,this.ESP_READ_REG=10,this.ESP_SPI_ATTACH=13,this.ESP_CHANGE_BAUDRATE=15,this.ESP_FLASH_DEFL_BEGIN=16,this.ESP_FLASH_DEFL_DATA=17,this.ESP_FLASH_DEFL_END=18,this.ESP_SPI_FLASH_MD5=19,this.ESP_ERASE_FLASH=208,this.ESP_ERASE_REGION=209,this.ESP_RUN_USER_CODE=211,this.ESP_IMAGE_MAGIC=233,this.ESP_CHECKSUM_MAGIC=239,this.ROM_INVALID_RECV_MSG=5,this.ERASE_REGION_TIMEOUT_PER_MB=3e4,this.ERASE_WRITE_TIMEOUT_PER_MB=4e4,this.MD5_TIMEOUT_PER_MB=8e3,this.CHIP_ERASE_TIMEOUT=12e4,this.MAX_TIMEOUT=this.CHIP_ERASE_TIMEOUT*2,this.CHIP_DETECT_MAGIC_REG_ADDR=1073745920,this.DETECTED_FLASH_SIZES={18:"256KB",19:"512KB",20:"1MB",21:"2MB",22:"4MB",23:"8MB",24:"16MB"},this.USB_JTAG_SERIAL_PID=4097,this.checksum=function(s){let o,d=239;for(o=0;o<s.length;o++)d^=s[o];return d},this.timeout_per_mb=function(s,o){const d=s*(o/1e6);return d<3e3?3e3:d},this.flash_size_bytes=function(s){let o=-1;return s.indexOf("KB")!==-1?o=parseInt(s.slice(0,s.indexOf("KB")))*1024:s.indexOf("MB")!==-1&&(o=parseInt(s.slice(0,s.indexOf("MB")))*1024*1024),o},this.IS_STUB=!1,this.FLASH_WRITE_SIZE=16384,this.terminal&&this.terminal.clean(),this.info("esptool.js"),this.info("Serial port "+this.transport.get_info())}_sleep(i){return new Promise(t=>setTimeout(t,i))}write(i,t=!0){this.terminal?t?this.terminal.writeLine(i):this.terminal.write(i):console.log(i)}error(i,t=!0){this.write(`Error: ${i}`,t)}info(i,t=!0){this.write(i,t)}debug(i,t=!0){this.debugLogging&&this.write(`Debug: ${i}`,t)}_short_to_bytearray(i){return new Uint8Array([i&255,i>>8&255])}_int_to_bytearray(i){return new Uint8Array([i&255,i>>8&255,i>>16&255,i>>24&255])}_bytearray_to_short(i,t){return i|t>>8}_bytearray_to_int(i,t,n,a){return i|t<<8|n<<16|a<<24}_appendBuffer(i,t){const n=new Uint8Array(i.byteLength+t.byteLength);return n.set(new Uint8Array(i),0),n.set(new Uint8Array(t),i.byteLength),n.buffer}_appendArray(i,t){const n=new Uint8Array(i.length+t.length);return n.set(i,0),n.set(t,i.length),n}ui8ToBstr(i){let t="";for(let n=0;n<i.length;n++)t+=String.fromCharCode(i[n]);return t}bstrToUi8(i){const t=new Uint8Array(i.length);for(let n=0;n<i.length;n++)t[n]=i.charCodeAt(n);return t}async flush_input(){try{await this.transport.rawRead(200)}catch(i){this.error(i.message)}}async command(i=null,t=new Uint8Array(0),n=0,a=!0,r=3e3){if(i!=null){const s=new Uint8Array(8+t.length);s[0]=0,s[1]=i,s[2]=this._short_to_bytearray(t.length)[0],s[3]=this._short_to_bytearray(t.length)[1],s[4]=this._int_to_bytearray(n)[0],s[5]=this._int_to_bytearray(n)[1],s[6]=this._int_to_bytearray(n)[2],s[7]=this._int_to_bytearray(n)[3];let o;for(o=0;o<t.length;o++)s[8+o]=t[o];await this.transport.write(s)}if(!a)return[0,new Uint8Array(0)];for(let s=0;s<100;s++){const o=await this.transport.read(r),d=o[0],l=o[1],c=this._bytearray_to_int(o[4],o[5],o[6],o[7]),_=o.slice(8);if(d==1){if(i==null||l==i)return[c,_];if(_[0]!=0&&_[1]==this.ROM_INVALID_RECV_MSG)throw await this.flush_input(),new P("unsupported command error")}}throw new P("invalid response")}async read_reg(i,t=3e3){const n=this._int_to_bytearray(i);return(await this.command(this.ESP_READ_REG,n,void 0,void 0,t))[0]}async write_reg(i,t,n=4294967295,a=0,r=0){let s=this._appendArray(this._int_to_bytearray(i),this._int_to_bytearray(t));s=this._appendArray(s,this._int_to_bytearray(n)),s=this._appendArray(s,this._int_to_bytearray(a)),r>0&&(s=this._appendArray(s,this._int_to_bytearray(this.chip.UART_DATE_REG_ADDR)),s=this._appendArray(s,this._int_to_bytearray(0)),s=this._appendArray(s,this._int_to_bytearray(0)),s=this._appendArray(s,this._int_to_bytearray(r))),await this.check_command("write target memory",this.ESP_WRITE_REG,s)}async sync(){this.debug("Sync");const i=new Uint8Array(36);let t;for(i[0]=7,i[1]=7,i[2]=18,i[3]=32,t=0;t<32;t++)i[4+t]=85;try{return await this.command(8,i,void 0,void 0,100)}catch(n){throw this.debug("Sync err "+n),n}}async _connect_attempt(i="default_reset",t=!1){this.debug("_connect_attempt "+i+" "+t),i!=="no_reset"&&(this.transport.get_pid()===this.USB_JTAG_SERIAL_PID?(await this.transport.setRTS(!1),await this.transport.setDTR(!1),await this._sleep(100),await this.transport.setDTR(!0),await this.transport.setRTS(!1),await this._sleep(100),await this.transport.setRTS(!0),await this.transport.setDTR(!1),await this.transport.setRTS(!0),await this._sleep(100),await this.transport.setRTS(!1),await this.transport.setDTR(!1)):(await this.transport.setDTR(!1),await this.transport.setRTS(!0),await this._sleep(100),t&&await this._sleep(2e3),await this.transport.setDTR(!0),await this.transport.setRTS(!1),await this._sleep(50),await this.transport.setDTR(!1)));let n=0,a=!0;for(;a;){try{const r=await this.transport.read(1e3);n+=r.length}catch(r){if(this.debug(r.message),r instanceof Error){a=!1;break}}await this._sleep(50)}for(this.transport.slip_reader_enabled=!0,n=7;n--;){try{const r=await this.sync();return this.debug(r[0].toString()),"success"}catch(r){r instanceof Error&&(t?this.info("_",!1):this.info(".",!1))}await this._sleep(50)}return"error"}async connect(i="default_reset",t=7,n=!1){let a,r;for(this.info("Connecting...",!1),await this.transport.connect(this.rom_baudrate),a=0;a<t&&(r=await this._connect_attempt(i,!1),!(r==="success"||(r=await this._connect_attempt(i,!0),r==="success")));a++);if(r!=="success")throw new P("Failed to connect with the device");if(this.info(`
\r`,!1),!n){const s=await this.read_reg(1073745920)>>>0;this.debug("Chip Magic "+s.toString(16));const o=await _s(s);if(this.chip===null)throw new P(`Unexpected CHIP magic value ${s}. Failed to autodetect chip type.`);this.chip=o}}async detect_chip(i="default_reset"){await this.connect(i),this.info("Detecting chip type... ",!1),this.chip!=null?this.info(this.chip.CHIP_NAME):this.info("unknown!")}async check_command(i="",t=null,n=new Uint8Array(0),a=0,r=3e3){this.debug("check_command "+i);const s=await this.command(t,n,a,void 0,r);return s[1].length>4?s[1]:s[0]}async mem_begin(i,t,n,a){this.debug("mem_begin "+i+" "+t+" "+n+" "+a.toString(16));let r=this._appendArray(this._int_to_bytearray(i),this._int_to_bytearray(t));r=this._appendArray(r,this._int_to_bytearray(n)),r=this._appendArray(r,this._int_to_bytearray(a)),await this.check_command("enter RAM download mode",this.ESP_MEM_BEGIN,r)}async mem_block(i,t){let n=this._appendArray(this._int_to_bytearray(i.length),this._int_to_bytearray(t));n=this._appendArray(n,this._int_to_bytearray(0)),n=this._appendArray(n,this._int_to_bytearray(0)),n=this._appendArray(n,i);const a=this.checksum(i);await this.check_command("write to target RAM",this.ESP_MEM_DATA,n,a)}async mem_finish(i){const t=i===0?1:0,n=this._appendArray(this._int_to_bytearray(t),this._int_to_bytearray(i));await this.check_command("leave RAM download mode",this.ESP_MEM_END,n,void 0,50)}async flash_spi_attach(i){const t=this._int_to_bytearray(i);await this.check_command("configure SPI flash pins",this.ESP_SPI_ATTACH,t)}async flash_begin(i,t){const n=Math.floor((i+this.FLASH_WRITE_SIZE-1)/this.FLASH_WRITE_SIZE),a=this.chip.get_erase_size(t,i),r=new Date,s=r.getTime();let o=3e3;this.IS_STUB==!1&&(o=this.timeout_per_mb(this.ERASE_REGION_TIMEOUT_PER_MB,i)),this.debug("flash begin "+a+" "+n+" "+this.FLASH_WRITE_SIZE+" "+t+" "+i);let d=this._appendArray(this._int_to_bytearray(a),this._int_to_bytearray(n));d=this._appendArray(d,this._int_to_bytearray(this.FLASH_WRITE_SIZE)),d=this._appendArray(d,this._int_to_bytearray(t)),this.IS_STUB==!1&&(d=this._appendArray(d,this._int_to_bytearray(0))),await this.check_command("enter Flash download mode",this.ESP_FLASH_BEGIN,d,void 0,o);const l=r.getTime();return i!=0&&this.IS_STUB==!1&&this.info("Took "+(l-s)/1e3+"."+(l-s)%1e3+"s to erase flash block"),n}async flash_defl_begin(i,t,n){const a=Math.floor((t+this.FLASH_WRITE_SIZE-1)/this.FLASH_WRITE_SIZE),r=Math.floor((i+this.FLASH_WRITE_SIZE-1)/this.FLASH_WRITE_SIZE),s=new Date,o=s.getTime();let d,l;this.IS_STUB?(d=i,l=3e3):(d=r*this.FLASH_WRITE_SIZE,l=this.timeout_per_mb(this.ERASE_REGION_TIMEOUT_PER_MB,d)),this.info("Compressed "+i+" bytes to "+t+"...");let c=this._appendArray(this._int_to_bytearray(d),this._int_to_bytearray(a));c=this._appendArray(c,this._int_to_bytearray(this.FLASH_WRITE_SIZE)),c=this._appendArray(c,this._int_to_bytearray(n)),(this.chip.CHIP_NAME==="ESP32-S2"||this.chip.CHIP_NAME==="ESP32-S3"||this.chip.CHIP_NAME==="ESP32-C3")&&this.IS_STUB===!1&&(c=this._appendArray(c,this._int_to_bytearray(0))),await this.check_command("enter compressed flash mode",this.ESP_FLASH_DEFL_BEGIN,c,void 0,l);const _=s.getTime();return i!=0&&this.IS_STUB===!1&&this.info("Took "+(_-o)/1e3+"."+(_-o)%1e3+"s to erase flash block"),a}async flash_block(i,t,n){let a=this._appendArray(this._int_to_bytearray(i.length),this._int_to_bytearray(t));a=this._appendArray(a,this._int_to_bytearray(0)),a=this._appendArray(a,this._int_to_bytearray(0)),a=this._appendArray(a,i);const r=this.checksum(i);await this.check_command("write to target Flash after seq "+t,this.ESP_FLASH_DATA,a,r,n)}async flash_defl_block(i,t,n){let a=this._appendArray(this._int_to_bytearray(i.length),this._int_to_bytearray(t));a=this._appendArray(a,this._int_to_bytearray(0)),a=this._appendArray(a,this._int_to_bytearray(0)),a=this._appendArray(a,i);const r=this.checksum(i);this.debug("flash_defl_block "+i[0].toString(16)+" "+i[1].toString(16)),await this.check_command("write compressed data to flash after seq "+t,this.ESP_FLASH_DEFL_DATA,a,r,n)}async flash_finish(i=!1){const t=i?0:1,n=this._int_to_bytearray(t);await this.check_command("leave Flash mode",this.ESP_FLASH_END,n)}async flash_defl_finish(i=!1){const t=i?0:1,n=this._int_to_bytearray(t);await this.check_command("leave compressed flash mode",this.ESP_FLASH_DEFL_END,n)}async run_spiflash_command(i,t,n){const o=this.chip.SPI_REG_BASE,d=o+0,l=o+this.chip.SPI_USR_OFFS,c=o+this.chip.SPI_USR1_OFFS,_=o+this.chip.SPI_USR2_OFFS,f=o+this.chip.SPI_W0_OFFS;let h;this.chip.SPI_MOSI_DLEN_OFFS!=null?h=async(w,k)=>{const b=o+this.chip.SPI_MOSI_DLEN_OFFS,y=o+this.chip.SPI_MISO_DLEN_OFFS;w>0&&await this.write_reg(b,w-1),k>0&&await this.write_reg(y,k-1)}:h=async(w,k)=>{const b=c,y=17,I=8,z=w===0?0:w-1,ue=(k===0?0:k-1)<<I|z<<y;await this.write_reg(b,ue)};const g=1<<18,v=28;if(n>32)throw new P("Reading more than 32 bits back from a SPI flash operation is unsupported");if(t.length>64)throw new P("Writing more than 64 bytes of data with one SPI command is unsupported");const p=t.length*8,m=await this.read_reg(l),x=await this.read_reg(_);let E=-2147483648,u;n>0&&(E|=268435456),p>0&&(E|=134217728),await h(p,n),await this.write_reg(l,E);let S=7<<v|i;if(await this.write_reg(_,S),p==0)await this.write_reg(f,0);else{if(t.length%4!=0){const k=new Uint8Array(t.length%4);t=this._appendArray(t,k)}let w=f;for(u=0;u<t.length-4;u+=4)S=this._bytearray_to_int(t[u],t[u+1],t[u+2],t[u+3]),await this.write_reg(w,S),w+=4}for(await this.write_reg(d,g),u=0;u<10&&(S=await this.read_reg(d)&g,S!=0);u++);if(u===10)throw new P("SPI command did not complete in time");const C=await this.read_reg(f);return await this.write_reg(l,m),await this.write_reg(_,x),C}async read_flash_id(){const t=new Uint8Array(0);return await this.run_spiflash_command(159,t,24)}async erase_flash(){this.info("Erasing flash (this may take a while)...");let i=new Date;const t=i.getTime(),n=await this.check_command("erase flash",this.ESP_ERASE_FLASH,void 0,void 0,this.CHIP_ERASE_TIMEOUT);i=new Date;const a=i.getTime();return this.info("Chip erase completed successfully in "+(a-t)/1e3+"s"),n}toHex(i){return Array.prototype.map.call(i,t=>("00"+t.toString(16)).slice(-2)).join("")}async flash_md5sum(i,t){const n=this.timeout_per_mb(this.MD5_TIMEOUT_PER_MB,t);let a=this._appendArray(this._int_to_bytearray(i),this._int_to_bytearray(t));a=this._appendArray(a,this._int_to_bytearray(0)),a=this._appendArray(a,this._int_to_bytearray(0));let r=await this.check_command("calculate md5sum",this.ESP_SPI_FLASH_MD5,a,void 0,n);return r instanceof Uint8Array&&r.length>16&&(r=r.slice(0,16)),this.toHex(r)}async run_stub(){this.info("Uploading stub...");let i=atob(this.chip.ROM_TEXT),t=i.split("").map(function(o){return o.charCodeAt(0)});const n=new Uint8Array(t);i=atob(this.chip.ROM_DATA),t=i.split("").map(function(o){return o.charCodeAt(0)});const a=new Uint8Array(t);let r=Math.floor((n.length+this.ESP_RAM_BLOCK-1)/this.ESP_RAM_BLOCK),s;for(await this.mem_begin(n.length,r,this.ESP_RAM_BLOCK,this.chip.TEXT_START),s=0;s<r;s++){const o=s*this.ESP_RAM_BLOCK,d=o+this.ESP_RAM_BLOCK;await this.mem_block(n.slice(o,d),s)}for(r=Math.floor((a.length+this.ESP_RAM_BLOCK-1)/this.ESP_RAM_BLOCK),await this.mem_begin(a.length,r,this.ESP_RAM_BLOCK,this.chip.DATA_START),s=0;s<r;s++){const o=s*this.ESP_RAM_BLOCK,d=o+this.ESP_RAM_BLOCK;await this.mem_block(a.slice(o,d),s)}this.info("Running stub..."),await this.mem_finish(this.chip.ENTRY);for(let o=0;o<100;o++){const d=await this.transport.read(1e3,6);if(d[0]===79&&d[1]===72&&d[2]===65&&d[3]===73)return this.info("Stub running..."),this.IS_STUB=!0,this.FLASH_WRITE_SIZE=16384,this.chip}throw new P("Failed to start stub. Unexpected response")}async change_baud(){this.info("Changing baudrate to "+this.baudrate);const i=this.IS_STUB?this.transport.baudrate:0,t=this._appendArray(this._int_to_bytearray(this.baudrate),this._int_to_bytearray(i)),n=await this.command(this.ESP_CHANGE_BAUDRATE,t);this.debug(n[0].toString()),this.info("Changed"),await this.transport.disconnect(),await this._sleep(50),await this.transport.connect(this.baudrate);try{await this.transport.rawRead(500)}catch(a){this.debug(a.message)}}async main_fn(i="default_reset"){await this.detect_chip(i);const t=await this.chip.get_chip_description(this);return this.info("Chip is "+t),this.info("Features: "+await this.chip.get_chip_features(this)),this.info("Crystal is "+await this.chip.get_crystal_freq(this)+"MHz"),this.info("MAC: "+await this.chip.read_mac(this)),await this.chip.read_mac(this),typeof this.chip._post_connect<"u"&&await this.chip._post_connect(this),await this.run_stub(),this.rom_baudrate!==this.baudrate&&await this.change_baud(),t}parse_flash_size_arg(i){if(typeof this.chip.FLASH_SIZES[i]>"u")throw new P("Flash size "+i+" is not supported by this chip type. Supported sizes: "+this.chip.FLASH_SIZES);return this.chip.FLASH_SIZES[i]}_update_image_flash_params(i,t,n,a,r){if(this.debug("_update_image_flash_params "+n+" "+a+" "+r),i.length<8||t!=this.chip.BOOTLOADER_FLASH_OFFSET)return i;if(n==="keep"&&a==="keep"&&r==="keep")return this.info("Not changing the image"),i;const s=parseInt(i[0]);let o=parseInt(i[2]);const d=parseInt(i[3]);if(s!==this.ESP_IMAGE_MAGIC)return this.info("Warning: Image file at 0x"+t.toString(16)+" doesn't look like an image file, so not changing any flash settings."),i;a!=="keep"&&(o={qio:0,qout:1,dio:2,dout:3}[a]);let l=d&15;r!=="keep"&&(l={"40m":0,"26m":1,"20m":2,"80m":15}[r]);let c=d&240;n!=="keep"&&(c=this.parse_flash_size_arg(n));const _=o<<8|l+c;return this.info("Flash params set to "+_.toString(16)),parseInt(i[2])!==o<<8&&(i=i.substring(0,2)+(o<<8).toString()+i.substring(2+1)),parseInt(i[3])!==l+c&&(i=i.substring(0,3)+(l+c).toString()+i.substring(3+1)),i}async write_flash(i,t="keep",n="keep",a="keep",r=!1,s=!0,o,d){if(this.debug("EspLoader program"),t!=="keep"){const _=this.flash_size_bytes(t);for(let f=0;f<i.length;f++)if(i[f].data.length+i[f].address>_)throw new P(`File ${f+1} doesn't fit in the available flash`)}this.IS_STUB===!0&&r===!0&&await this.erase_flash();let l,c;for(let _=0;_<i.length;_++){this.debug("Data Length "+i[_].data.length),l=i[_].data;const f=i[_].data.length%4;if(f>0&&(l+="".substring(4-f)),c=i[_].address,this.debug("Image Length "+l.length),l.length===0){this.debug("Warning: File is empty");continue}l=this._update_image_flash_params(l,c,t,n,a);let h=null;d&&(h=d(l),this.debug("Image MD5 "+h));const g=l.length;let v;if(s){const b=this.bstrToUi8(l);l=this.ui8ToBstr(hs(b,{level:9})),v=await this.flash_defl_begin(g,l.length,c)}else v=await this.flash_begin(g,c);let p=0,m=0;const x=l.length;o&&o(_,0,x);let E=new Date;const u=E.getTime();let S=5e3;const C=new fs({chunkSize:1});let w=0;for(C.onData=function(b){w+=b.byteLength};l.length>0;){this.debug("Write loop "+c+" "+p+" "+v),this.info("Writing at 0x"+(c+w).toString(16)+"... ("+Math.floor(100*(p+1)/v)+"%)");const b=this.bstrToUi8(l.slice(0,this.FLASH_WRITE_SIZE));if(s){const y=w;C.push(b,!1);const I=w-y;let z=3e3;this.timeout_per_mb(this.ERASE_WRITE_TIMEOUT_PER_MB,I)>3e3&&(z=this.timeout_per_mb(this.ERASE_WRITE_TIMEOUT_PER_MB,I)),this.IS_STUB===!1&&(S=z),await this.flash_defl_block(b,p,S),this.IS_STUB&&(S=z)}else throw new P("Yet to handle Non Compressed writes");m+=b.length,l=l.slice(this.FLASH_WRITE_SIZE,l.length),p++,o&&o(_,m,x)}this.IS_STUB&&await this.read_reg(this.CHIP_DETECT_MAGIC_REG_ADDR,S),E=new Date;const k=E.getTime()-u;if(s&&this.info("Wrote "+g+" bytes ("+m+" compressed) at 0x"+c.toString(16)+" in "+k/1e3+" seconds."),h){const b=await this.flash_md5sum(c,g);if(new String(b).valueOf()!=new String(h).valueOf())throw this.info("File  md5: "+h),this.info("Flash md5: "+b),new P("MD5 of file does not match data in flash!");this.info("Hash of data verified.")}}this.info("Leaving..."),this.IS_STUB&&(await this.flash_begin(0,0),s?await this.flash_defl_finish():await this.flash_finish())}async flash_id(){this.debug("flash_id");const i=await this.read_flash_id();this.info("Manufacturer: "+(i&255).toString(16));const t=i>>16&255;this.info("Device: "+(i>>8&255).toString(16)+t.toString(16)),this.info("Detected flash size: "+this.DETECTED_FLASH_SIZES[t])}async hard_reset(){await this.transport.setRTS(!0),await this._sleep(100),await this.transport.setRTS(!1)}async soft_reset(){if(!this.IS_STUB)await this.flash_begin(0,0),await this.flash_finish(!1);else{if(this.chip.CHIP_NAME!="ESP8266")throw new P("Soft resetting is currently only supported on ESP8266");await this.command(this.ESP_RUN_USER_CODE,void 0,void 0,!1)}}}class gs{constructor(i){this.device=i,this.slip_reader_enabled=!1,this.left_over=new Uint8Array(0),this.baudrate=0,this._DTR_state=!1}get_info(){const i=this.device.getInfo();return i.usbVendorId&&i.usbProductId?`WebSerial VendorID 0x${i.usbVendorId.toString(16)} ProductID 0x${i.usbProductId.toString(16)}`:""}get_pid(){return this.device.getInfo().usbProductId}slip_writer(i){let t=0,n=0,a=0;for(n=0;n<i.length;n++)(i[n]===192||i[n]===219)&&t++;const r=new Uint8Array(2+t+i.length);for(r[0]=192,a=1,n=0;n<i.length;n++,a++){if(i[n]===192){r[a++]=219,r[a]=220;continue}if(i[n]===219){r[a++]=219,r[a]=221;continue}r[a]=i[n]}return r[a]=192,r}async write(i){const t=this.slip_writer(i);if(this.device.writable){const n=this.device.writable.getWriter();await n.write(t),n.releaseLock()}}_appendBuffer(i,t){const n=new Uint8Array(i.byteLength+t.byteLength);return n.set(new Uint8Array(i),0),n.set(new Uint8Array(t),i.byteLength),n.buffer}slip_reader(i){let t=0,n=0,a=0,r="init";for(;t<i.length;){if(r==="init"&&i[t]==192){n=t+1,r="valid_data",t++;continue}if(r==="valid_data"&&i[t]==192){a=t-1,r="packet_complete";break}t++}if(r!=="packet_complete")return this.left_over=i,new Uint8Array(0);this.left_over=i.slice(a+2);const s=new Uint8Array(a-n+1);let o=0;for(t=n;t<=a;t++,o++){if(i[t]===219&&i[t+1]===220){s[o]=192,t++;continue}if(i[t]===219&&i[t+1]===221){s[o]=219,t++;continue}s[o]=i[t]}return s.slice(0,o)}async read(i=0,t=12){let n,a=this.left_over;if(this.left_over=new Uint8Array(0),this.slip_reader_enabled){const s=this.slip_reader(a);if(s.length>0)return s;a=this.left_over,this.left_over=new Uint8Array(0)}if(this.device.readable==null)return this.left_over;const r=this.device.readable.getReader();try{i>0&&(n=setTimeout(function(){r.cancel()},i));do{const{value:s,done:o}=await r.read();if(o)throw this.left_over=a,new Error("Timeout");a=new Uint8Array(this._appendBuffer(a.buffer,s.buffer))}while(a.length<t)}finally{i>0&&clearTimeout(n),r.releaseLock()}return this.slip_reader_enabled?this.slip_reader(a):a}async rawRead(i=0){if(this.left_over.length!=0){const a=this.left_over;return this.left_over=new Uint8Array(0),a}if(!this.device.readable)return this.left_over;const t=this.device.readable.getReader();let n;try{i>0&&(n=setTimeout(function(){t.cancel()},i));const{value:a,done:r}=await t.read();if(r)throw new Error("Timeout");return a}finally{i>0&&clearTimeout(n),t.releaseLock()}}async setRTS(i){await this.device.setSignals({requestToSend:i}),await this.setDTR(this._DTR_state)}async setDTR(i){this._DTR_state=i,await this.device.setSignals({dataTerminalReady:i})}async connect(i=115200){await this.device.open({baudRate:i}),this.baudrate=i,this.left_over=new Uint8Array(0)}async sleep(i){return new Promise(t=>setTimeout(t,i))}async waitForUnlock(i){for(;this.device.readable&&this.device.readable.locked||this.device.writable&&this.device.writable.locked;)await this.sleep(i)}async disconnect(){await this.waitForUnlock(400),await this.device.close()}}let ae=!1;function ws(e){ae=e}class vn{constructor(i,t,n=""){this.espLoader=null,this.cachedDeviceInfo=null,this.terminal=i,this.flashMap=t,this.baseUrl=n}patchBytes(i,t,n){const a=new Uint8Array(i);for(let r=0;r<=a.length-t.length;r++){let s=!0;for(let o=0;o<t.length;o++)if(a[r+o]!==t[o]){s=!1;break}if(s){for(let o=0;o<n.length;o++)a[r+o]=n[o];ae&&(this.terminal.writeLine(`[DEBUG] Found pattern [${t.join(", ")}] at offset 0x${r.toString(16)}`),this.terminal.writeLine(`[DEBUG] Replaced with [${n.join(", ")}]`));break}}return a.buffer}patchConfig(i,t){const n=new TextEncoder,a=new Uint8Array(i),r={flasher:"webflasherv3",devicename:"O.MG"};t&&(r.wifimode=t.mode==="ap"?"2":"1",r.wifissid=t.ssid,r.wifikey=t.password);let s="INIT;F:keylog=0;";for(let d=1;d<8;d++)s+=`F:payload${d}=0;`;s+="F:bootscript=4;F:hidxfile=16;";for(let d=1;d<51;d++)s+=`F:payload${d}=4;`;s+="F:keylog=100%F;";for(const[d,l]of Object.entries(r))s+=`S:${d}=${l};`;s+="\0";const o=n.encode(s);for(let d=0;d<o.length&&d<a.length;d++)a[d]=o[d];return ae?(this.terminal.writeLine("[DEBUG] Full config string:"),this.terminal.writeLine(s)):this.terminal.writeLine(`[INFO] Patched config: ${s.substring(0,50)}...`),a.buffer}patchWifi(i,t){const n=new TextEncoder,a=new Uint8Array(i);if(!t)return a.buffer;const r={hostname:"OMG"};t.mode==="ap"?r.soft_ap={ssid:t.ssid,key:t.password,channel:1}:r.station={ap_list:[{ssid:t.ssid,key:t.password,primary:1}]};let s=JSON.stringify(r)+"\0";const o=n.encode(`WIFI${s}`);for(let d=0;d<o.length&&d<a.length;d++)a[d]=o[d];return ae?(this.terminal.writeLine("[DEBUG] Full WiFi config:"),this.terminal.writeLine(`WIFI${s}`)):this.terminal.writeLine(`[INFO] Patched WiFi config: mode=${t.mode}, ssid=${t.ssid}`),a.buffer}patchFirmware(i,t){this.terminal.writeLine("[INFO] Applying firmware patches..."),ae&&(this.terminal.writeLine(`[DEBUG] Total files to patch: ${i.length}`),this.terminal.writeLine(`[DEBUG] WiFi config provided: ${t?"yes":"no"}`));for(let n=0;n<i.length;n++){const a=i[n],r="0x"+a.address.toString(16).padStart(5,"0");ae&&this.terminal.writeLine(`[DEBUG] Processing file: ${a.name} at ${r} (${a.data.byteLength} bytes)`),r==="0x00000"?(this.terminal.writeLine(`[INFO] Patching base firmware at ${r}`),i[n].data=this.patchBytes(a.data,[0,32],[3,48])):r==="0x7f000"?(this.terminal.writeLine(`[INFO] Patching config section at ${r}`),i[n].data=this.patchConfig(a.data,t)):r==="0x7e000"&&(this.terminal.writeLine(`[INFO] Patching WiFi section at ${r}`),i[n].data=this.patchWifi(a.data,t))}return this.terminal.writeLine("[OK] Firmware patches applied"),i}async loadFile(i,t){const n=t||(this.baseUrl?`${this.baseUrl}/${i}`:i);if(window.cacheManager&&(n.startsWith("http://")||n.startsWith("https://")))try{const r=await window.cacheManager.fetchWithCache(n,"binary");return r.buffer.slice(r.byteOffset,r.byteLength+r.byteOffset)}catch{this.terminal.writeLine(`[WARNING] Cache fetch failed for ${i}, falling back to direct fetch`)}let a=3;for(;a>0;)try{const r=await fetch(n);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const s=await r.blob();if(s.size===0)throw new Error("Empty file received");return await s.arrayBuffer()}catch(r){if(a--,a===0)throw new Error(`Failed to load file: ${i} from ${n} - ${r}`);this.terminal.writeLine(`[INFO] Retry loading ${i}... (${3-a}/3)`),await new Promise(s=>setTimeout(s,1e3))}throw new Error(`Failed to load file after retries: ${i}`)}arrayBufferToBinaryString(i){const t=new Uint8Array(i);let n="";for(let a=0;a<t.byteLength;a++)n+=String.fromCharCode(t[a]);return n}async readFlashData(i,t){if(!this.espLoader||!this.espLoader.chip)return this.terminal.writeLine("[ERROR] Not connected to ESP device"),null;try{const a=new Uint8Array(t);for(let r=0;r<t;r+=4){const s=Math.min(4,t-r),o=i+r,d=new Uint8Array([o>>16&255,o>>8&255,o&255]),l=await this.espLoader.run_spiflash_command(3,d,s*8);for(let c=0;c<s;c++)a[r+c]=l>>c*8&255}return a}catch(n){return this.terminal.writeLine(`[ERROR] Failed to read flash at 0x${i.toString(16)}: ${n}`),null}}parseDeviceInfo(i){try{const t=new DataView(i.buffer,i.byteOffset,i.byteLength);let n=0;const a=t.getUint16(n,!0);if(n+=2,a!==48927)return{valid:!1,magic_code:a};const r=new TextDecoder("utf-8").decode(i.slice(n,n+4));n+=4;const s=t.getUint8(n);n+=1;const o=i.slice(n,n+8),d=new TextDecoder("utf-8").decode(o).replace(/\0/g,"");n+=8;const l=i.slice(n,n+18),c=new TextDecoder("utf-8").decode(l).replace(/\0/g,"");n+=18;const _=i.slice(n,n+12),f=new TextDecoder("utf-8").decode(_).replace(/\0/g,"");n+=12;const h=t.getUint32(n,!0);n+=4;const g=t.getUint32(n,!0);n+=4;const v=t.getUint8(n);n+=1;const p=t.getUint16(n,!0);n+=2;const m=t.getUint16(n,!0);n+=2;const x=t.getUint16(n,!0);return n+=2,{valid:!0,magic_code:a,prod_type:r,flash_size:s,device_id:d,fwver:c,branch:f,commit:h,firmware_checksum:g,ofat_ver:v,ofat_filespace_size:p,ofat_freespace:m,pagempfs_size:x}}catch(t){return this.terminal.writeLine(`[ERROR] Failed to parse device info: ${t}`),null}}async connect(i){let n=1;try{const a=i||await navigator.serial.requestPort(),r=new gs(a);for(this.espLoader=new us(r,115200,this.terminal);n<=4;)try{this.terminal.writeLine(`[INFO] Connecting... (attempt ${n}/4)`),await this.espLoader.connect(),await new Promise(s=>setTimeout(s,50)),this.terminal.writeLine("[OK] Connected to ESP device"),this.terminal.writeLine("[INFO] Uploading stub flasher..."),await this.espLoader.run_stub(),this.terminal.writeLine("[OK] Stub flasher running");break}catch(s){if((s.name==="BreakError"||s.name==="BufferOverrunError")&&n<4){this.terminal.writeLine(`[WARNING] Caught ${s.name}, retrying in ${n*500}ms...`),await new Promise(o=>setTimeout(o,n*500)),n++;continue}throw s}if(n>4)throw new Error("Failed to connect after multiple retries")}catch(a){throw this.terminal.writeLine(`[ERROR] Connection error: ${a}`),a}}async getFlashSize(){var i;if(!this.espLoader||!this.espLoader.chip)throw new Error("Not connected to ESP device");try{let t=1024,n=!1;try{const a=await this.espLoader.read_flash_id(),r=a>>16&255,s=(i=this.espLoader.DETECTED_FLASH_SIZES)==null?void 0:i[r];s?(s.toUpperCase().endsWith("MB")?t=(parseInt(s,10)||1)*1024:s.toUpperCase().endsWith("KB")&&(t=parseInt(s,10)||1024),n=!0,this.terminal.writeLine(`[INFO] Detected flash size from RDID 0x${a.toString(16)} (code 0x${r.toString(16)}): ${t}KB (${t/1024}MB)`)):this.terminal.writeLine(`[WARNING] Flash ID 0x${a.toString(16)} has unknown size code 0x${r.toString(16)}, trying efuse fallback...`)}catch{this.terminal.writeLine("[WARNING] Could not read SPI flash ID, trying efuse fallback...")}if(!n)try{if(typeof this.espLoader.chip.read_efuse=="function"){const a=await this.espLoader.chip.read_efuse(this.espLoader,2);(await this.espLoader.chip.read_efuse(this.espLoader,0)&16|a&65536)!=0?((await this.espLoader.chip.read_efuse(this.espLoader,3)>>24&15)>=2?t=2048:t=1024,this.terminal.writeLine(`[INFO] Detected ESP8285 with flash size from efuse: ${t}KB (${t/1024}MB)`)):this.terminal.writeLine("[INFO] ESP8266EX detected, using default 1MB (external flash size unknown)")}else this.terminal.writeLine("[INFO] No efuse-based flash size available, using default 1MB")}catch{this.terminal.writeLine("[WARNING] Could not read efuse for flash size, using default 1MB")}return t.toString()}catch{return this.terminal.writeLine("[WARNING] Flash size detection failed, defaulting to 1MB"),this.terminal.writeLine("[INFO] Please manually select the correct flash size if needed"),"1024"}}async flash(i="1024",t,n){if(!this.espLoader||!this.espLoader.chip)throw new Error("Not connected to ESP device");const a=this.flashMap[i];if(!a)throw new Error(`Flash size ${i}KB not found in flash map`);const r=a.filter(h=>h.type==="file"||h.type==="blank").length,s=110+r*100;let o=0;const d=(h,g,v)=>{let p=Math.round(h/s*100);p<o?p=o:o=p,n==null||n({phase:g,percent:p,message:v})};d(0,"loading","Starting flash process..."),this.terminal.writeLine("----------------------------------------"),this.terminal.writeLine(`[INFO] Starting flash process for ${i}KB flash size`),this.terminal.writeLine(`[INFO] Base URL: ${this.baseUrl}`),this.terminal.writeLine(`[INFO] Files to process: ${a.length}`);const l=[];let c=0;for(const h of a)try{const g=parseInt(h.offset,16);if(h.type==="file"){this.terminal.writeLine(`[INFO] Loading file: ${h.name} from ${h.url||"local"}`);const p=await this.loadFile(h.name,h.url);l.push({data:p,address:g,name:h.name});const m=Math.round(p.byteLength/1024*100)/100;this.terminal.writeLine(`[OK] Loaded ${h.name}: ${p.byteLength} bytes (${m}KB) -> flash offset 0x${g.toString(16).toUpperCase()}`)}else if(h.type==="blank"){const m=new Uint8Array(4096).fill(255);l.push({data:m.buffer,address:g,name:h.name}),this.terminal.writeLine(`[INFO] Blank region: ${h.name} at 0x${g.toString(16).toUpperCase()} (4096 bytes)`)}c++;const v=Math.round(c/r*10);d(v,"loading",`Loaded ${h.name}`)}catch(g){throw this.terminal.writeLine(`[ERROR] Error processing ${h.name}: ${g}`),g}if(l.length===0)throw new Error("No files to flash");d(10,"patching","Applying firmware patches...");const _=this.patchFirmware(l,t);d(110,"patching","Patches applied");const f=_.map(h=>({data:this.arrayBufferToBinaryString(h.data),address:h.address}));this.terminal.writeLine(`[INFO] Writing ${f.length} file(s) to flash...`);for(let h=0;h<f.length;h++){const g=_[h],v=Math.round(g.data.byteLength/1024*100)/100;this.terminal.writeLine(`[INFO] File ${h+1}/${f.length}: ${g.name} -> 0x${f[h].address.toString(16).toUpperCase()} (${v}KB)`)}d(110,"flashing","Writing to flash..."),await this.espLoader.write_flash(f,"keep","keep","keep",!1,!0,(h,g,v)=>{const p=Math.round(g/v*100),m=_[h],x=m?m.name:`file${h+1}`;this.terminal.write(`\r[INFO] Writing ${x}: ${p}% (${g}/${v} bytes)`);const E=110+h*100+p;d(E,"flashing",`Writing ${x}: ${p}%`)}),this.terminal.writeLine(`
[OK] Flash process completed successfully`),d(s,"complete","Flash completed successfully!")}async readDeviceInfo(i=520192){var t,n,a,r;if(!this.espLoader||!this.espLoader.chip)return this.terminal.writeLine("[ERROR] Not connected to ESP device"),console.error("Not connected to ESP device"),null;if(this.cachedDeviceInfo!==null)return console.log("Using cached device info:",JSON.stringify(this.cachedDeviceInfo,null,2)),this.cachedDeviceInfo;try{this.terminal.writeLine(`[INFO] Reading device info from flash at 0x${i.toString(16).toUpperCase()}...`),console.log(`Reading device info from flash at 0x${i.toString(16).toUpperCase()}...`);const s=60,o=await this.readFlashData(i,s);if(!o)return console.error("Failed to read flash data"),null;const d=this.parseDeviceInfo(o);return d&&(this.cachedDeviceInfo=d,d.valid?(this.terminal.writeLine("[OK] Valid device info found"),this.terminal.writeLine(`[INFO] Magic Code: 0x${(t=d.magic_code)==null?void 0:t.toString(16).toUpperCase()}`),this.terminal.writeLine(`[INFO] Product Type: ${d.prod_type}`),this.terminal.writeLine(`[INFO] Flash Size: ${d.flash_size}MB`),this.terminal.writeLine(`[INFO] Device ID: ${d.device_id}`),this.terminal.writeLine(`[INFO] Firmware Version: ${d.fwver}`),this.terminal.writeLine(`[INFO] Branch: ${d.branch}`),this.terminal.writeLine(`[INFO] Commit: 0x${(n=d.commit)==null?void 0:n.toString(16).toUpperCase()}`),console.log("Device Info:",JSON.stringify(d,null,2))):(this.terminal.writeLine(`[WARNING] Invalid magic code: 0x${(a=d.magic_code)==null?void 0:a.toString(16).toUpperCase()} (expected 0xBF1F)`),console.warn(`Invalid magic code: 0x${(r=d.magic_code)==null?void 0:r.toString(16).toUpperCase()} (expected 0xBF1F)`),console.log("Device Info:",JSON.stringify(d,null,2)))),d}catch(s){return this.terminal.writeLine(`[ERROR] Failed to read device info: ${s}`),console.error("Failed to read device info:",s),null}}async disconnect(){if(this.espLoader)try{if(this.espLoader.transport){try{await this.espLoader.hard_reset()}catch{}try{await this.espLoader.transport.disconnect()}catch{}}}catch{}finally{this.espLoader=null,this.cachedDeviceInfo=null,this.terminal.writeLine("[INFO] Disconnected from ESP device")}}}function ps(e){const i=document.getElementById(e);i&&i.classList.contains("completed")&&i.classList.toggle("active")}function ms(e){const i=document.getElementById(e);i&&(i.classList.remove("active"),i.classList.add("completed"))}function bs(e){const i=document.getElementById(e);i&&(i.classList.add("active"),i.classList.remove("completed"))}window.toggleStep=ps;window.setStepCompleted=ms;window.setStepActive=bs;const Ti=document.getElementById("agreeBtn");Ti&&Ti.addEventListener("click",()=>{localStorage.setItem("agreementAccepted","true")});const Ri=document.getElementById("disagreeBtn");Ri&&Ri.addEventListener("click",()=>{window.location.href="https://o.mg.lol"});var Bi;(Bi=document.getElementById("uploadCustomBinary"))==null||Bi.addEventListener("change",e=>{const i=e.target;document.getElementById("customBinarySection").style.display=i.checked?"block":"none"});var Di;(Di=document.getElementById("customizeWifi"))==null||Di.addEventListener("change",e=>{const i=e.target;document.getElementById("wifiConfigSection").style.display=i.checked?"block":"none"});var Oi;(Oi=document.getElementById("saveSettings"))==null||Oi.addEventListener("click",()=>{var i;const e={customizeWifi:document.getElementById("customizeWifi").checked,wifiMode:(i=document.querySelector('input[name="wifiMode"]:checked'))==null?void 0:i.value,ssidName:document.getElementById("ssidName").value,wifiPassword:document.getElementById("wifiPassword").value,uploadCustomBinary:document.getElementById("uploadCustomBinary").checked};localStorage.setItem("omgFlasherSettings",JSON.stringify(e)),bootstrap.Modal.getInstance(document.getElementById("settingsModal")).hide(),Nt("Settings saved successfully!","success")});function ys(){const e=localStorage.getItem("omgFlasherSettings");if(e)try{const i=JSON.parse(e);if(i.customizeWifi&&(document.getElementById("customizeWifi").checked=!0,document.getElementById("wifiConfigSection").style.display="block"),i.wifiMode){const t=document.querySelector(`input[name="wifiMode"][value="${i.wifiMode}"]`);t&&(t.checked=!0)}i.ssidName&&(document.getElementById("ssidName").value=i.ssidName),i.wifiPassword&&(document.getElementById("wifiPassword").value=i.wifiPassword),i.uploadCustomBinary&&(document.getElementById("uploadCustomBinary").checked=!0,document.getElementById("customBinarySection").style.display="block")}catch(i){console.error("Failed to load settings:",i)}}ys();function Es(){const e=localStorage.getItem("omgFlasherSettings");if(e)try{const i=JSON.parse(e);if(i.customizeWifi)return{ssid:i.ssidName||"O.MG",password:i.wifiPassword||"12345678",mode:i.wifiMode==="existing"?"station":"ap"}}catch(i){console.error("Failed to load WiFi settings:",i)}return{ssid:"O.MG",password:"12345678",mode:"ap"}}window.getWifiConfig=Es;var zi;(zi=document.getElementById("clearConsole"))==null||zi.addEventListener("click",()=>{document.getElementById("consoleTerminal").innerHTML=""});var Pi;(Pi=document.getElementById("downloadLogs"))==null||Pi.addEventListener("click",()=>{const e=document.getElementById("consoleTerminal").textContent,i=new Blob([e],{type:"text/plain"}),t=URL.createObjectURL(i),n=document.createElement("a");n.href=t,n.download=`omg-flasher-logs-${new Date().toISOString()}.txt`,n.click(),URL.revokeObjectURL(t)});function Nt(e,i="info"){const t=document.getElementById("alertArea"),n=document.createElement("div");n.className=`alert alert-${i} alert-dismissible fade show`,n.innerHTML=`
        ${e}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `,t.appendChild(n),setTimeout(()=>n.remove(),5e3)}var $i;($i=document.getElementById("step2HelpBtn"))==null||$i.addEventListener("click",()=>{Nt("Troubleshooting Tips:<br>1. Make sure your USB cable supports data transfer<br>2. Try a different USB port<br>3. Check if drivers are installed for your device<br>4. On Windows, you may need CH340 or CP2102 drivers<br>5. Try unplugging and replugging the device","info")});var Ni;(Ni=document.getElementById("step3HelpBtn"))==null||Ni.addEventListener("click",()=>{Nt("Make sure your device stays connected during the flashing process. Do not unplug or disconnect until complete.","info")});class Ss{constructor(){this.CACHE_PREFIX="omg_flasher_",this.CACHE_DURATION=2*60*60*1e3,this.METADATA_KEY=this.CACHE_PREFIX+"metadata"}getMetadata(){try{const i=localStorage.getItem(this.METADATA_KEY);return i?JSON.parse(i):{}}catch(i){return console.error("Error reading cache metadata:",i),{}}}setMetadata(i){try{localStorage.setItem(this.METADATA_KEY,JSON.stringify(i))}catch(t){console.error("Error saving cache metadata:",t)}}getCacheKey(i){return this.CACHE_PREFIX+btoa(i).replace(/[^a-zA-Z0-9]/g,"_")}isExpired(i){return Date.now()-i>this.CACHE_DURATION}async get(i,t="json"){const n=this.getCacheKey(i);try{const a=localStorage.getItem(n);if(!a)return null;const{data:r,timestamp:s,contentType:o}=JSON.parse(a);if(this.isExpired(s))return console.log(`[Cache] Expired: ${i}`),this.remove(i),null;if(console.log(`[Cache] Hit: ${i}`),t==="binary"){const d=atob(r),l=new Uint8Array(d.length);for(let c=0;c<d.length;c++)l[c]=d.charCodeAt(c);return l}else return JSON.parse(r)}catch(a){return console.error(`[Cache] Error reading ${i}:`,a),this.remove(i),null}}async set(i,t,n="json"){const a=this.getCacheKey(i);try{let r;if(n==="binary"){const d=new Uint8Array(t);let l="";for(let c=0;c<d.length;c++)l+=String.fromCharCode(d[c]);r=btoa(l)}else r=JSON.stringify(t);const s={data:r,timestamp:Date.now(),contentType:n,url:i,size:r.length};localStorage.setItem(a,JSON.stringify(s));const o=this.getMetadata();o[a]={url:i,timestamp:s.timestamp,size:s.size,type:n},this.setMetadata(o),console.log(`[Cache] Stored: ${i} (${this.formatBytes(s.size)})`)}catch(r){if(console.error(`[Cache] Error storing ${i}:`,r),r.name==="QuotaExceededError"){console.warn("[Cache] Quota exceeded, clearing old items..."),this.clearOldest(5);try{await this.set(i,t,n)}catch(s){console.error("[Cache] Still unable to cache after cleanup:",s)}}}}remove(i){const t=this.getCacheKey(i);localStorage.removeItem(t);const n=this.getMetadata();delete n[t],this.setMetadata(n),console.log(`[Cache] Removed: ${i}`)}clearAll(){const i=this.getMetadata();Object.keys(i).forEach(t=>{localStorage.removeItem(t)}),localStorage.removeItem(this.METADATA_KEY),console.log("[Cache] All cache cleared")}clearOldest(i=5){const t=this.getMetadata();Object.entries(t).sort((a,r)=>a[1].timestamp-r[1].timestamp).slice(0,i).forEach(([a,r])=>{localStorage.removeItem(a),delete t[a],console.log(`[Cache] Removed old item: ${r.url}`)}),this.setMetadata(t)}getStats(){const i=this.getMetadata(),t=Object.values(i),n=t.reduce((s,o)=>s+(o.size||0),0),a=t.filter(s=>s.type==="json").length,r=t.filter(s=>s.type==="binary").length;return{totalItems:t.length,totalSize:n,totalSizeFormatted:this.formatBytes(n),jsonCount:a,binaryCount:r,items:t.map(s=>({url:s.url,type:s.type,size:this.formatBytes(s.size),age:this.formatAge(Date.now()-s.timestamp)}))}}formatBytes(i){if(i===0)return"0 Bytes";const t=1024,n=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(i)/Math.log(t));return Math.round(i/Math.pow(t,a)*100)/100+" "+n[a]}formatAge(i){const t=Math.floor(i/6e4);if(t<60)return`${t}m ago`;const n=Math.floor(t/60);return n<24?`${n}h ago`:`${Math.floor(n/24)}d ago`}async fetchWithCache(i,t="json",n=!1){if(!n){const a=await this.get(i,t);if(a!==null)return a}console.log(`[Cache] Fetching: ${i}`);try{const a=await fetch(i);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);let r;if(t==="binary"){const s=await a.arrayBuffer();r=new Uint8Array(s)}else r=await a.json();return await this.set(i,r,t),r}catch(a){throw console.error(`[Cache] Fetch error for ${i}:`,a),a}}async preloadJSON(i){console.log("[Cache] Pre-loading JSON files...");const t=i.map(n=>this.fetchWithCache(n,"json").catch(a=>(console.error(`[Cache] Failed to preload ${n}:`,a),null)));await Promise.all(t),console.log("[Cache] JSON pre-load complete")}}const vs=new Ss;window.cacheManager=vs;class xs{constructor(){this.wizardData=null,this.currentStep=null,this.wizardState={},this.flasher=null,this.agreementScreen=document.getElementById("agreementScreen"),this.startScreen=document.getElementById("startScreen"),this.wizardContainer=document.getElementById("wizardContainer"),this.advancedContainer=document.getElementById("advancedContainer"),this.wizardSteps=document.getElementById("wizardSteps"),this.progressBar=document.getElementById("wizardProgress"),this.progressSteps=document.getElementById("progressSteps"),this.init()}async init(){try{await this.loadWizardData(),this.setupEventListeners(),this.hideAllContainers(),await this.showAgreementModal()}catch(i){console.error("Failed to initialize wizard:",i)}}async showAgreementModal(){const i=document.getElementById("agreementContent"),t=document.getElementById("licenseText"),n=document.getElementById("scrollProgress"),a=document.getElementById("agreeBtn"),r=document.getElementById("disagreeBtn");this.showScreen("agreementScreen");try{let o;if(window.cacheManager)o=await(await fetch("./assets/license.md")).text();else{const l=await fetch("./assets/license.md");if(l.ok)o=await l.text();else throw new Error("Failed to load license")}const d=this.markdownToHtml(o);t.innerHTML=d}catch(o){console.error("Error loading license:",o),t.textContent="Error loading agreement. Please try again."}const s=()=>{if(!i)return;const o=i.scrollTop,d=i.scrollHeight,l=i.clientHeight,c=o/(d-l)*100;n&&(n.style.width=c+"%",n.setAttribute("aria-valuenow",c)),o+l>=d-5&&a&&(a.disabled=!1)};i&&(i.addEventListener("scroll",s),setTimeout(s,100)),a==null||a.addEventListener("click",()=>{this.showStartScreen()},{once:!0}),r==null||r.addEventListener("click",()=>{window.close(),setTimeout(()=>{window.location.href="about:blank"},100)},{once:!0})}async loadWizardData(){try{if(window.cacheManager)this.wizardData=await window.cacheManager.fetchWithCache("./assets/wizard.json","json");else{const i=await fetch("./assets/wizard.json");if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);this.wizardData=await i.json()}console.log("Wizard data loaded:",this.wizardData)}catch(i){throw console.error("Error loading wizard data:",i),i}}markdownToHtml(i){let t=i.replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^# (.*$)/gim,'<h1 class="h4 fw-bold mt-4 mb-3">$1</h1>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/```([\s\S]*?)```/g,'<pre class="bg-light p-3 rounded"><code>$1</code></pre>').replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/\n\n/g,'</p><p class="mb-3">');return t='<p class="mb-3">'+t+"</p>",t}setupEventListeners(){var i,t,n,a;(i=document.getElementById("guidedSetupBtn"))==null||i.addEventListener("click",()=>{this.startGuidedSetup()}),(t=document.getElementById("advancedBtn"))==null||t.addEventListener("click",()=>{this.startAdvancedMode()}),(n=document.getElementById("backToStartBtn"))==null||n.addEventListener("click",()=>{this.showStartScreen()}),(a=document.getElementById("backToStartFromAdvanced"))==null||a.addEventListener("click",()=>{this.showStartScreen()})}showStartScreen(){this.showScreen("startScreen")}startGuidedSetup(){this.showScreen("wizardContainer"),this.initializeProgressBar(),this.goToStep("hardware_check")}startAdvancedMode(){this.showScreen("advancedContainer")}hideAllContainers(){this.agreementScreen.classList.add("d-none"),this.startScreen.classList.add("d-none"),this.wizardContainer.classList.add("d-none"),this.advancedContainer.classList.add("d-none")}showScreen(i){this.hideAllContainers();const t=document.getElementById(i);t&&t.classList.remove("d-none")}initializeProgressBar(){const i=[{id:"hardware",label:"Hardware",steps:["hardware_check","programmer_detected","modern_programmer","legacy_programmer"]},{id:"connection",label:"Connection",steps:["device_connection","device_detected"]},{id:"flashing",label:"Flashing",steps:["firmware_selection","flash_stable","flash_beta","flash_legacy","flash_complete"]}];this.progressSteps.innerHTML="",i.forEach((t,n)=>{const a=document.createElement("div");a.className="progress-step",a.innerHTML=`
        <div class="step-number">${n+1}</div>
        <div class="step-label">${t.label}</div>
      `,a.dataset.stepId=t.id,a.dataset.steps=JSON.stringify(t.steps),this.progressSteps.appendChild(a)})}updateProgressBar(i){const t=this.progressSteps.querySelectorAll(".progress-step");let n=-1;t.forEach((r,s)=>{const o=JSON.parse(r.dataset.steps);r.classList.remove("active","completed"),o.includes(i)?(n=s,r.classList.add("active")):(n>s||n===-1&&s===0)&&r.classList.add("completed")});const a=n>=0?(n+1)/t.length*100:0;this.progressBar.style.width=`${a}%`}async goToStep(i){const t=this.wizardData.find(n=>n.step===i);if(!t){console.error("Step not found:",i);return}if(this.currentStep=t,this.updateProgressBar(i),t.validator)try{const n=await this.runValidator(t.validator,t);n!==void 0&&(this.wizardState[t.validator]=n)}catch(n){console.error("Validator error:",n)}if(t.auto_advance&&t.next_step){const n=this.determineNextStep(t);if(n){setTimeout(()=>this.goToStep(n),1e3);return}}this.renderStep(t)}renderStep(i){this.wizardSteps.innerHTML="",console.log("Rendering step:",i),console.log("Step message:",i.message);const t=document.createElement("div");t.className=`wizard-step step-${i.step_type||"default"}`;let a=`
      <div class="step-header">
        <div class="step-icon">${this.getStepIcon(i.step_type)}</div>
        <h2 class="step-title">${i.title||"Untitled Step"}</h2>
      </div>
    `;if(i.message&&(a+=`
        <div class="wizard-message-content">
          <p class="step-message">${this.processMessage(i.message)}</p>
        </div>
      `),i.step==="flash_complete"){const r=window.getWifiConfig?window.getWifiConfig():null;if(r){const s=r.mode==="ap"?"Access Point (AP)":"Station (Client)";a+=`
          <div class="card mt-3 mb-3">
            <div class="card-header bg-success text-white">
              <i class="bi bi-wifi me-2"></i><strong>WiFi Configuration</strong>
            </div>
            <div class="card-body">
              <table class="table table-sm table-borderless mb-0">
                <tr>
                  <td class="fw-bold" style="width: 100px;">Mode:</td>
                  <td>${s}</td>
                </tr>
                <tr>
                  <td class="fw-bold">SSID:</td>
                  <td><code>${r.ssid}</code></td>
                </tr>
                <tr>
                  <td class="fw-bold">Password:</td>
                  <td><code>${r.password}</code></td>
                </tr>
              </table>
            </div>
          </div>
        `}}i.help_message&&(a+=`
        <div class="step-help-section">
          <button class="btn btn-link btn-sm p-0" onclick="this.nextElementSibling.classList.toggle('d-none')">
            <i class="bi bi-question-circle me-1"></i>Need help?
          </button>
          <div class="alert alert-info mt-2 d-none">
            <small>${i.help_message}</small>
          </div>
        </div>
      `),a+=`
      <div class="step-actions">
        ${this.renderStepActions(i)}
      </div>
    `,t.innerHTML=a,this.wizardSteps.appendChild(t)}getStepIcon(i){return{detection:'<i class="bi bi-search"></i>',info:'<i class="bi bi-info-circle-fill"></i>',warning:'<i class="bi bi-exclamation-triangle-fill"></i>',error:'<i class="bi bi-x-circle-fill"></i>',success:'<i class="bi bi-check-circle-fill"></i>',action:'<i class="bi bi-gear-fill"></i>',menu:'<i class="bi bi-list-ul"></i>'}[i]||'<i class="bi bi-circle-fill"></i>'}processMessage(i){return i.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}renderStepActions(i){let t="";if(i.step_type==="menu"&&i.options){const n=i.options.find(r=>r.label.toLowerCase().includes("try")&&(r.label.toLowerCase().includes("again")||r.label.toLowerCase().includes("detection"))),a=i.options.filter(r=>r!==n);a.length>0&&(t+='<div class="wizard-option-list mb-4">',a.forEach((r,s)=>{t+=`
            <div class="wizard-option-item" onclick="wizard.handleMenuOption('${r.next}', '${r.firmware||""}')">
              <span class="option-number">${s+1}</span>
              <span class="option-label">${r.label}</span>
              <i class="bi bi-chevron-right option-arrow"></i>
            </div>
          `}),t+="</div>"),n&&(t+=`
          <button class="btn btn-primary btn-lg w-100 fw-bold" onclick="wizard.handleMenuOption('${n.next}', '${n.firmware||""}')">
            <i class="bi bi-arrow-clockwise me-2"></i>${n.label}
          </button>
        `)}else i.step_type==="action"?(t+=`
        <button class="btn btn-success btn-lg" id="wizardActionBtn" onclick="wizard.handleAction('${i.action}', '${i.firmware||""}')">
          <span class="spinner-border spinner-border-sm d-none me-2"></span>
          Start ${i.title}
        </button>
      `,i.action==="flash_firmware"&&(t+=`
          <div id="wizardFlashProgress" class="mt-3 w-100" style="display: none;">
            <div class="d-flex justify-content-between mb-1">
              <span id="wizardFlashLabel" class="small fw-bold">Flashing...</span>
              <span id="wizardFlashPercent" class="small">0%</span>
            </div>
            <div class="progress" style="height: 20px;">
              <div id="wizardFlashBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #c41e3a;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        `)):i.next_step&&(Array.isArray(i.next_step)?i.next_step:[{step:i.next_step,label:"Continue"}]).forEach(a=>{(!a.condition||this.checkCondition(a.condition))&&(t+=`
            <button class="btn btn-primary btn-lg me-2" onclick="wizard.goToStep('${a.step}')">
              ${a.label||"Continue"}
            </button>
          `)});return i.external_link&&(t+=`
        <a href="${i.external_link}" target="_blank" class="btn btn-outline-primary btn-lg me-2">
          <i class="fas fa-external-link-alt"></i> Visit Link
        </a>
      `),t}handleMenuOption(i,t=""){t&&(this.wizardState.selectedFirmware=t),this.goToStep(i)}async handleAction(i,t=""){const n=event.target,a=n.querySelector(".spinner-border");n.disabled=!0,a==null||a.classList.remove("d-none");try{switch(i){case"select_port":await this.selectPort();break;case"connect_device":await this.connectDevice();break;case"flash_firmware":await this.flashFirmware(t||this.wizardState.selectedFirmware);break;default:console.warn("Unknown action:",i)}const r=this.determineNextStep(this.currentStep);r&&this.goToStep(r)}catch(r){console.error("Action failed:",r)}finally{n.disabled=!1,a==null||a.classList.add("d-none")}}async selectPort(){var i,t,n;try{(i=window.ErrorHandler)==null||i.logInfo("Requesting serial port selection...");const a=await navigator.serial.requestPort();this.wizardState.selectedPort=a,(t=window.ErrorHandler)==null||t.logInfo("Serial port selected successfully")}catch(a){throw console.error("Port selection failed:",a),(n=window.ErrorHandler)==null||n.logError("Port selection cancelled or failed"),a}}async connectDevice(){try{const i=window.terminal,t=window.ErrorHandler;t.logInfo("Connecting to device..."),window.getFlashMap()||(t.logInfo("Loading memory map..."),await window.loadMemoryMap());const a=window.selectedBranch,r=window.baseUrl,s=a.includes("branch-")?a.split("-")[1]:a,o=`${r}/${s}/firmware`,d=window.ESPFlasher,l=new d(i,window.getFlashMap(),o);window.setFlasher(l);const c=this.wizardState.selectedPort;await l.connect(c),this.wizardState.programmer_version===2?t.logInfo("Using modern programmer (v2) - visual indicators on programmer show device status"):t.logInfo("Using legacy programmer (v1)");try{const _=await l.getFlashSize();_==="1024"||_==="2048"?window.setDetectedFlashSize(_):window.setDetectedFlashSize("1024"),t.logInfo(`Detected ${window.getDetectedFlashSize()}KB flash size and will use it for flashing`)}catch{window.setDetectedFlashSize("1024"),t.logWarning("Flash size detection failed, defaulting to 1024KB (1MB)")}this.wizardState.device_connected=!0}catch(i){throw console.error("Connection error:",i),i}}async flashFirmware(i){const t=window.getFlasher();if(t){const n=document.getElementById("firmwareBuild");n&&(n.value=i);const a=document.getElementById("wizardFlashProgress"),r=document.getElementById("wizardFlashBar"),s=document.getElementById("wizardFlashLabel"),o=document.getElementById("wizardFlashPercent"),d=document.getElementById("wizardActionBtn");a&&(a.style.display="block");const l=f=>{r&&(r.style.width=`${f.percent}%`,r.setAttribute("aria-valuenow",f.percent.toString())),o&&(o.textContent=`${f.percent}%`),s&&(f.phase==="loading"?s.textContent="Loading firmware files...":f.phase==="patching"?s.textContent="Patching firmware...":f.phase==="flashing"?s.textContent=f.message||"Writing to device...":f.phase==="complete"&&(s.textContent="Flash complete!",r&&r.classList.remove("progress-bar-animated"))),d&&(f.phase==="loading"?d.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Loading...':f.phase==="patching"?d.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Patching...':f.phase==="flashing"?d.innerHTML=`<span class="spinner-border spinner-border-sm me-2"></span>Flashing ${f.percent}%`:f.phase==="complete"&&(d.innerHTML='<i class="bi bi-check-circle me-2"></i>Complete!'))},c=window.getWifiConfig?window.getWifiConfig():void 0;c&&window.ErrorHandler.logInfo(`WiFi Config: SSID=${c.ssid}, Mode=${c.mode}`);const _=window.getDetectedFlashSize();window.ErrorHandler.logInfo(`Starting flash process with ${_}KB flash size (auto-detected)`),await t.flash(_,c,l),window.ErrorHandler.logInfo("Flash completed successfully!")}else throw new Error("Flasher not available")}determineNextStep(i){if(!i.next_step)return null;if(typeof i.next_step=="string")return i.next_step;if(Array.isArray(i.next_step)){for(const t of i.next_step)if(!t.condition||this.checkCondition(t.condition))return t.step}return null}checkCondition(i){switch(i){case"programmer_found":return this.wizardState.programmer_detected===!0;case"no_programmer":return this.wizardState.programmer_detected===!1;case"modern_programmer":return this.wizardState.programmer_type==="modern";case"legacy_programmer":return this.wizardState.programmer_type==="legacy";case"device_connected":return this.wizardState.device_connected===!0;case"device_not_connected":return this.wizardState.device_connected===!1;default:return!0}}async runValidator(i,t){switch(i){case"checkHardwareConnection":return await this.checkHardwareConnection();case"detectProgrammerType":return await this.detectProgrammerType();default:return console.warn("Unknown validator:",i),!0}}async checkHardwareConnection(){try{if(!navigator.serial)return this.wizardState.programmer_detected=!1,!1;const i=await navigator.serial.getPorts();return this.wizardState.programmer_detected=i.length>0,i.length>0}catch(i){return console.error("Hardware check failed:",i),this.wizardState.programmer_detected=!1,!1}}async detectProgrammerType(){var i,t,n,a;try{const r=this.wizardState.selectedPort;if(!r)throw new Error("No port selected - please select a port first");r.readable!==null||await r.open({baudRate:115200});let o=1;try{console.log("Starting programmer detection..."),await r.setSignals({dataTerminalReady:!1}),await new Promise(_=>setTimeout(_,50));let d=await r.getSignals();console.log("Initial signals:",d);let l=!0;const c=[!0,!1,!0];for(const _ of c){await r.setSignals({dataTerminalReady:_}),await new Promise(h=>setTimeout(h,50)),d=await r.getSignals();const f=d.dataSetReady;if(console.log(`DTR=${_}, DSR=${f}, Match=${f===_}`),f!==_){l=!1,console.log("Signal mismatch detected, this is a legacy programmer");break}}l?(o=2,console.log("Found programmer version: 2 (modern)"),(i=window.ErrorHandler)==null||i.logInfo("Detected modern programmer (v2) - no reconnection required")):(console.log("Found programmer version: 1 (legacy)"),(t=window.ErrorHandler)==null||t.logInfo("Detected legacy programmer (v1)"))}catch(d){console.warn("Signal detection failed, defaulting to version 1:",d),(n=window.ErrorHandler)==null||n.logWarning("Signal detection failed, assuming legacy programmer")}try{await r.close(),console.log("Closed port after programmer detection")}catch(d){console.warn("Error closing port:",d)}return this.wizardState.programmer_version=o,this.wizardState.programmer_type=o===2?"modern":"legacy",this.wizardState.programmer_type}catch(r){return console.error("Programmer detection failed:",r),(a=window.ErrorHandler)==null||a.logWarning("Programmer detection cancelled or failed"),this.wizardState.programmer_version=1,this.wizardState.programmer_type="legacy","legacy"}}}let Ci;document.addEventListener("DOMContentLoaded",()=>{Ci=new xs,window.wizard=Ci});let He=null;window.setDebugMode=ws;window.getDebugMode=()=>ae;let xn="https://raw.githubusercontent.com/O-MG/O.MG-Firmware",Me="stable";const Ft="https://api.github.com/repos/O-MG/O.MG-Firmware/releases?per_page=100";async function Ut(){try{if(window.cacheManager)He=await window.cacheManager.fetchWithCache("./assets/memmap.json","json");else{const e=await fetch("./assets/memmap.json");if(!e.ok)throw new Error(`Failed to load memory map: ${e.status}`);He=await e.json()}T.logInfo("Memory map loaded successfully")}catch(e){throw T.logError(`Failed to load memory map: ${e}`),e}}async function In(){var e;try{let i;if(window.cacheManager)i=await window.cacheManager.fetchWithCache(Ft,"json");else{const n=await fetch(Ft);if(!n.ok)throw new Error("Failed to load firmware releases");i=await n.json()}if(i.message)return T.logError("Invalid data, cannot load current releases list"),{};const t={};for(let n=0;n<i.length;n++){const a=i[n];a.target_commitish&&!t[a.target_commitish]&&a.draft===!1&&(t[a.target_commitish]={name:a.name||a.tag_name,tag_name:a.tag_name,version:a.tag_name,author:(e=a.author)==null?void 0:e.login,target_commitish:a.target_commitish})}return t}catch(i){return T.logError("Failed to fetch firmware releases",i),{}}}async function Is(){try{let e=await In();const i=["legacy-v1.5","legacy-v2.0"];for(const n in e)for(const a of i)n.includes(a)&&delete e[n];const t=document.getElementById("firmwareBuild");if(t){t.innerHTML="";const n=["stable","legacy-2.5","beta"];let a=!0;for(let r=0;r<n.length;r++){const s=n[r];if(e[s]){let o=e[s].name;a&&(o=o+" (Default)",a=!1);const d=new Option(o,s,!a,!a);t.add(d),delete e[s]}}for(const r in e){const s=e[r];t.add(new Option(s.name,r,!1,!1))}T.logInfo("Firmware releases loaded")}}catch(e){T.logWarning(`Could not load firmware releases: ${e}`)}}function W(e){return e.replace(/[]/g,"[OK]").replace(/[]/g,"[ERROR]").replace(/[]/g,"[WARNING]").replace(/[]/g,"[INFO]").replace(/[]/g,"-").replace(/[]/g,"v").replace(/[]/g,"^").replace(/[]/g,"->").replace(/[]/g,"<-").replace(/[]/g,"[CMD]").replace(/[]/g,"[SETTINGS]").replace(/[\u2000-\u206F\u2E00-\u2E7F\u3000-\u303F\uFE30-\uFE4F]/g," ").replace(/[^\x00-\x7F]/g,"?")}class T{static showFatalError(i,t){const n=document.getElementById("fatalErrorModal"),a=document.getElementById("fatalErrorMessage"),r=document.getElementById("fatalErrorDetails");a&&r&&(a.querySelector("p").textContent=W(i),r.textContent=W(t||"No additional details available.")),n&&new window.bootstrap.Modal(n).show(),Q.writeLine(`[FATAL ERROR] ${W(i)}`),t&&Q.writeLine(`[FATAL ERROR DETAILS] ${W(t)}`)}static logError(i,t){const n=t?`${i}: ${t.toString()}`:i;Q.writeLine(`[ERROR] ${W(n)}`)}static logWarning(i){Q.writeLine(`[WARNING] ${W(i)}`)}static logInfo(i){Q.writeLine(`[INFO] ${W(i)}`)}}const st={log:console.log,error:console.error,warn:console.warn,info:console.info};console.log=(...e)=>{const i=e.map(t=>typeof t=="string"?t:JSON.stringify(t)).join(" ");Q.writeLine(`[LOG] ${W(i)}`),st.log(...e)};console.error=(...e)=>{const i=e.map(t=>typeof t=="string"?t:JSON.stringify(t)).join(" ");T.logError(i),st.error(...e)};console.warn=(...e)=>{const i=e.map(t=>typeof t=="string"?t:JSON.stringify(t)).join(" ");T.logWarning(i),st.warn(...e)};console.info=(...e)=>{const i=e.map(t=>typeof t=="string"?t:JSON.stringify(t)).join(" ");T.logInfo(i),st.info(...e)};const Q={clean(){const e=document.getElementById("consoleTerminal");e&&(e.innerHTML="")},writeLine(e){var a;const i=document.getElementById("consoleTerminal"),t=((a=document.getElementById("autoScroll"))==null?void 0:a.checked)??!0,n=W(e);if(i){const r=document.createElement("div");r.textContent=n,i.appendChild(r),t&&(i.scrollTop=i.scrollHeight)}},write(e){var a;const i=document.getElementById("consoleTerminal"),t=((a=document.getElementById("autoScroll"))==null?void 0:a.checked)??!0,n=W(e);if(i){if(n.includes("\r")){const r=i.children;if(r.length>0){const s=r[r.length-1],o=n.split("\r");s.textContent=o[o.length-1]}else{const s=document.createElement("div");s.textContent=n.replace(/\r/g,""),i.appendChild(s)}}else if(n.includes(`
`)){const r=n.split(`
`);for(let s=0;s<r.length;s++)if(s===0&&i.children.length>0){const o=i.children[i.children.length-1];o.textContent+=r[s]}else if(r[s]||s<r.length-1){const o=document.createElement("div");o.textContent=r[s],i.appendChild(o)}}else if(i.children.length>0){const r=i.children[i.children.length-1];r.textContent+=n}else{const r=document.createElement("div");r.textContent=n,i.appendChild(r)}t&&(i.scrollTop=i.scrollHeight)}}};let J=null,ce="1024";window.getFlasher=()=>J;window.setFlasher=e=>{J=e};window.getDetectedFlashSize=()=>ce;window.setDetectedFlashSize=e=>{ce=e};window.ESPFlasher=vn;window.terminal=Q;window.getFlashMap=()=>He;window.loadMemoryMap=Ut;window.getFirmwareReleases=In;window.baseUrl=xn;window.selectedBranch=Me;window.ErrorHandler=T;const Te=document.getElementById("connectBtn"),D=document.getElementById("flashBtn"),re=document.getElementById("disconnectBtn");Te==null||Te.addEventListener("click",async()=>{try{T.logInfo("Connecting to device..."),He||(T.logInfo("Loading memory map..."),await Ut());const e=Me.includes("branch-")?Me.split("-")[1]:Me,i=`${xn}/${e}/firmware`;J=new vn(Q,He,i),await J.connect();try{const t=await J.getFlashSize();t==="1024"||t==="2048"?ce=t:ce="1024",T.logInfo(`Detected ${ce/1024}MB flash size and will use it for flashing`)}catch{ce="1024",T.logWarning("Flash size detection failed, defaulting to 1MB")}Te.disabled=!0,D.disabled=!1,re&&(re.disabled=!1),setStepCompleted("step2"),setStepActive("step2-flash"),T.logInfo("Connected successfully! Ready to flash.")}catch(e){T.showFatalError("Failed to connect to device",e==null?void 0:e.toString())}});D==null||D.addEventListener("click",async()=>{if(!J){T.logError("Not connected to a device");return}try{D.disabled=!0,D.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Programming...';const e=ce;T.logInfo(`Starting flash process with ${e}KB flash size (auto-detected)`);const i=window.getWifiConfig?window.getWifiConfig():void 0;i&&T.logInfo(`WiFi Config: SSID=${i.ssid}, Mode=${i.mode}`);const t=document.getElementById("flashProgressContainer"),n=document.getElementById("flashProgressBar"),a=document.getElementById("flashProgressLabel"),r=document.getElementById("flashProgressPercent");t&&(t.style.display="block");const s=o=>{n&&(n.style.width=`${o.percent}%`,n.setAttribute("aria-valuenow",o.percent.toString())),r&&(r.textContent=`${o.percent}%`),o.phase==="loading"?(D.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Loading...',a&&(a.textContent="Loading firmware files...")):o.phase==="patching"?(D.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Patching...',a&&(a.textContent="Patching firmware...")):o.phase==="flashing"?(D.innerHTML=`<span class="spinner-border spinner-border-sm me-2"></span>Flashing ${o.percent}%`,a&&(a.textContent=o.message||"Writing to device...")):o.phase==="complete"&&(D.innerHTML='<i class="bi bi-check-circle me-2"></i>Complete!',a&&(a.textContent="Flash complete!"),n&&n.classList.remove("progress-bar-animated"))};await J.flash(e,i,s),setStepCompleted("step2-flash"),T.logInfo("Flash completed successfully!"),Fi(!0,i),setTimeout(()=>{D.innerHTML="Program"},2e3)}catch(e){T.showFatalError("Flash process failed",e==null?void 0:e.toString()),D.innerHTML="Program",D.disabled=!1;const i=document.getElementById("flashProgressBar"),t=document.getElementById("flashProgressLabel");i&&(i.style.width="0%",i.classList.add("bg-danger")),t&&(t.textContent="Flash failed!"),Fi(!1,void 0,e==null?void 0:e.toString())}});function Fi(e,i,t){const n=document.getElementById("step3"),a=document.getElementById("flashResultHeader"),r=document.getElementById("flashResultIcon"),s=document.getElementById("flashResultTitle"),o=document.getElementById("flashResultMessage"),d=document.getElementById("flashResultWifiInfo"),l=document.getElementById("flashResultWifiMode"),c=document.getElementById("flashResultWifiSSID"),_=document.getElementById("flashResultWifiPassword");if(n)if(n.style.display="block",n.classList.add("active"),e&&n.classList.add("completed"),e){a.className="card-header d-flex align-items-center bg-success text-white",r.className="bi bi-check-circle-fill me-2",s.textContent="Flash Successful!",o.textContent="Your O.MG device has been successfully flashed with the new firmware.";const f=window.getWifiConfig?window.getWifiConfig():null;f&&d&&(d.style.display="block",l&&(l.textContent=f.mode==="ap"?"Access Point (AP)":"Station (Client)"),c&&(c.textContent=f.ssid),_&&(_.textContent=f.password))}else a.className="card-header d-flex align-items-center bg-danger text-white",r.className="bi bi-x-circle-fill me-2",s.textContent="Flash Failed",o.textContent=t||"An error occurred during the flash process. Please check the terminal for details.",d&&(d.style.display="none")}re==null||re.addEventListener("click",async()=>{if(J)try{await J.disconnect(),T.logInfo("Disconnected from device.")}catch(e){T.logError("Error disconnecting",e)}finally{J=null,Te.disabled=!1,D.disabled=!0,re&&(re.disabled=!0);const e=document.getElementById("step2"),i=document.getElementById("step2-flash"),t=document.getElementById("step3");e&&(e.classList.remove("completed"),e.classList.add("active")),i&&i.classList.remove("completed","active"),t&&(t.style.display="none",t.classList.remove("completed","active"))}});function kn(){if(window.cacheManager){const e=window.cacheManager.getStats(),i=document.getElementById("cacheItemCount"),t=document.getElementById("cacheSize"),n=document.getElementById("cacheJsonCount"),a=document.getElementById("cacheBinaryCount");i&&(i.textContent=e.totalItems.toString()),t&&(t.textContent=e.totalSizeFormatted),n&&(n.textContent=e.jsonCount.toString()),a&&(a.textContent=e.binaryCount.toString())}}const Mi=document.getElementById("settingsModal");Mi&&Mi.addEventListener("show.bs.modal",()=>{kn()});const St=document.getElementById("clearCacheBtn");St==null||St.addEventListener("click",()=>{window.cacheManager&&confirm("Are you sure you want to clear all cached firmware files? They will be re-downloaded when needed.")&&(window.cacheManager.clearAll(),kn(),T.logInfo("Cache cleared successfully"))});window.cacheManager&&window.cacheManager.preloadJSON(["./assets/memmap.json","./assets/wizard.json",Ft]).catch(e=>{console.error("Error pre-loading JSON files:",e)});T.logInfo("Ready to flash ESP device.");Promise.all([Ut(),Is()]).catch(e=>{T.logWarning("Could not load all resources. Some features may be limited.")});const me=document.getElementById("firmwareBuild");me==null||me.addEventListener("change",()=>{Me=me.value,T.logInfo(`Selected firmware: ${me.options[me.selectedIndex].text}`)});
//# sourceMappingURL=main-37f9266a.js.map
